<style>
    tr.warning {
        background-color: #F5AEBD !important;
    }
</style>
<script>
    setTimeout(() => {
        window.location.reload();
    }, 10 * 60 * 1000)

    const additionalTimeApprover = {additionalTimeApprover};
    const pendingTimeLimitActionThresholdMinutes = {pendingTimeLimitActionThresholdMinutes};

    document.addEventListener('DOMContentLoaded', () => {
        $('#timeRequestTable').DataTable({
            dom: 'rt',
            columns: [
                {data: "customerName", name: "customerName"},
                {
                    data: "serviceRequestId", name: "serviceRequestId", render: (data, type, row, meta) => {
                        if (type === 'sort') {
                            return data;
                        }

                        return '<a href="Activity.php?action=displayLastActivity&problemID=' + data + '" target="_blank">' + data + '</a>';
                    }
                },
                {data: "requesterTeam", name: 'requesterTeam'},
                {data: 'requesterName', name: 'requesterName'},
                {
                    data: 'requestedAt', name: 'requestedAt', render: (data, type, row, meta) => {
                        if (type === 'sort') {
                            return data;
                        }
                        if (!data) {
                            return '';
                        }
                        return moment(data, 'YYYY-MM-DD HH:mm:ss').format('DD/MM/YYYY HH:mm:ss');
                    }
                },
                {data: "notes", name: "notes"},
                {data: "approvalLevel", name: "approvalLevel"},
                {data: "chargeableHours", name: "chargeableHours"},
                {data: "timeSpentSoFar", name: "timeSpentSoFar"},
                {data: "timeLeftOnBudget", name: "timeLeftOnBudget"},
                {
                    data: "activityId", name: "activityId", sortable: false, render: (data, type, row, meta) => {
                        if (!row.isOverLimit || additionalTimeApprover) {
                            return "<button><a target='_blank' href='Activity.php?action=timeRequestReview&callActivityID=" + row.activityId + "'>Process Time Request</a>" +
                                "</button>";
                        }
                        return '';
                    }
                },
            ],
            createdRow: (row, data, index) => {
                const alertTime = moment().subtract(pendingTimeLimitActionThresholdMinutes, 'minutes');
                if (moment(data.requestedAt, 'YYYY-MM-DD HH:mm:ss').isSameOrBefore(alertTime)) {
                    row.classList.add('warning');
                }
            },

            order: [[4, "asc"]],
            serverSide: false,
            ajax: {
                url: "?action=getData",
                type: "GET",
                dataSrc: (response) => {
                    $.LoadingOverlay('hide');
                    return response.data;
                },
                data: (data) => {
                    $.LoadingOverlay("show", {text: 'Fetching data, please wait'});
                    return data;
                }
            },
        });
    })


</script>


<table class="oddRows"
       id="timeRequestTable"
>
    <thead>
    <tr>
        <th>
            Customer Name
        </th>
        <th>
            SR Link
        </th>
        <th>
            Team of Requester
        </th>
        <th>
            Requester Name
        </th>
        <th>
            Requested Date&Time
        </th>
        <th>
            Notes
        </th>
        <th>
            Approval Level
        </th>
        <th>
            Chargeable Hours
        </th>
        <th>
            Time Spent So Far
        </th>
        <th>
            Time Left On Budget
        </th>
        <th>
            Process Time Request
        </th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>