<script src="components/dist/SpinnerHolder.js"></script>
<div id="reactSpinnerHolder"></div>
<link rel="stylesheet"
      href="components/dist/SpinnerHolder.css"
>
<script>

    let allocationUsers = [];

    fetch('?action=getAllocationUsers').then(res => res.json()).then(response => {
        allocationUsers = response.data;
    })

    document.addEventListener('DOMContentLoaded', () => {

        $('#salesRequestTable tbody').on('change', 'select', function () {

            const userId = this.value || null;
            const problemId = this.dataset.problemId;
            fetch('?action=assignUser', {
                method: 'POST',
                body: JSON.stringify({
                    problemId,
                    userId
                })
            })

        })


        $('#salesRequestTable').DataTable({
            dom: 'rt',
            paging: false,
            columns: [
                {data: "customerName", name: "customerName"},
                {
                    data: "serviceRequestId", name: "serviceRequestId", render: (data, type, row, meta) => {
                        if (type === 'sort') {
                            return data;
                        }

                        return '<a href="Activity.php?action=displayLastActivity&problemID=' + data + '" target="_blank">' + data + '</a>';
                    }
                },
                {data: "requestBody", name: 'requestBody'},
                {data: 'requesterName', name: 'requesterName'},
                {
                    data: 'requestedAt', name: 'requestedAt', render: (data, type, row, meta) => {
                        if (type === 'sort') {
                            return data;
                        }
                        if (!data) {
                            return '';
                        }
                        return moment(data, 'YYYY-MM-DD HH:mm:ss').format('DD/MM/YYYY HH:mm:ss');
                    }
                },
                {
                    data: "attachments", name: "attachments", render: (data, type, row, meta) => {
                        if (type === 'sort') {
                            return data.length;
                        }
                        return data.map(documentId => {
                            return "<a href='/Activity.php?action=viewFile&callDocumentID=" + documentId + "' target='_blank'><i class='fa fa-paperclip'></i></a>";
                        }).join('');
                    }
                },
                {data: "type", name: "type"},
                {
                    data: "salesRequestAssignedUserId",
                    name: "salesRequestAssignedUserId",
                    render: (data, type, row, meta) => {


                        const selectElm = document.createElement('select');
                        selectElm.dataset.problemId = row.serviceRequestId;
                        selectElm.classList.add('userAllocation');

                        const emptyOption = document.createElement('option');
                        emptyOption.text = '';
                        emptyOption.value = '';
                        selectElm.options.add(emptyOption);
                        let selectedUserName = '';
                        allocationUsers.forEach((allocationUser, index) => {
                            const option = new Option(allocationUser.fullName, allocationUser.id, allocationUser.id === data, allocationUser.id === data)
                            if (allocationUser.id === data) {
                                selectedUserName = allocationUser.fullName;
                            }
                            selectElm.options.add(option);
                        })
                        if (type === 'sort') {
                            return selectedUserName;
                        }
                        return selectElm.outerHTML;
                    }
                },
                {
                    data: "activityId", name: "activityId", sortable: false, render: (data, type, row, meta) => {
                        return "<button><a target='_blank' href='Activity.php?action=salesRequestReview&callActivityID=" + row.activityId + "'>Process Sales Request</a>" +
                            "</button>";
                    }
                },
            ],
            order: [[4, "asc"]],
            serverSide: false,
            createdRow: (row, data, index) => {
                row.classList.add('topAlign');
            },
            ajax: {
                url: "?action=getData",
                type: "GET",
                dataSrc: (response) => {
                    spinnerComponent.hideSpinner();
                    return response.data;
                },
                data: (data) => {
                    spinnerComponent.showSpinner();
                    return data;
                }
            },
        });


    })
</script>
<table class="oddRows"
       id="salesRequestTable"
>
    <thead>
    <tr>
        <th>
            Customer Name
        </th>
        <th>
            SR Link
        </th>
        <th>
            Sales Request
        </th>
        <th>
            Requested By
        </th>
        <th>
            Requested Date & Time
        </th>
        <th>
            Attachments
        </th>
        <th>
            Type
        </th>
        <th>
            Assigned To
        </th>
        <th></th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>