<!-- Template: CustomerEdit.inc.html -->
<script language='JavaScript'
        src='.javascript/ajax.js'
></script>
<script src="//cdnjs.cloudflare.com/ajax/libs/jquery-form-validator/2.3.26/jquery.form-validator.js"></script>
<div id="newPasswordDialog"
     title="New Password"
>
    <fieldset id="register">
        <label>Password </label>
        <input type="password"
               id="password"
        >
        <span class="comment"
              id="passwordComment"
        ></span>
        <label>Repeat Password </label>
        <input type="password"
               id="repeatPassword"
        >
        <span class="comment"
              id="repeatPasswordComment"
        ></span>
    </fieldset>
    <br>
    <div>
        <button onclick="saveNewPassword()"
                disabled
                id="savePasswordButton"
        >Save
        </button>
        <button onclick="cancelNewPassword()">Cancel</button>
    </div>
</div>
<script id="contact-row"
        type="text/template"
>
    <tr>
        <td>
            <input type="hidden"
                   name="form[contact][0][contactID]"
                   value="0"
            >
            <input type="hidden"
                   name="form[customer][{customerID}][crmComments]"
                   value="{crmComments}"
            >
            <input type="hidden"
                   name="form[contact][0][customerID]"
                   value="{customerID}"
            >
            <input type="hidden"
                   name="form[contact][0][supplierID]"
                   value="0"
            >
            <input type="hidden"
                   name="form[contact][0][fax]"
                   value=""
            >
            <input type="hidden"
                   name="form[contact][0][discontinuedFlag]"
                   value="N"
            >
            <div class="contactClear">
            </div>
        </td>
        <td>
            <div class="contactSite">
                <select name="form[contact][0][siteNo]"
                        data-validation="required"
                >
                    <!-- BEGIN templateSelectSiteBlock -->
                    <option value="{selectSiteNo}"
                    >{selectSiteDesc}
                    </option>
                    <!-- END templateSelectSiteBlock -->
                </select>
            </div>
        </td>
        <td>
            <div class="contactTitle">

                <input name="form[contact][0][title]"
                       size="2"
                       maxlength="10"
                       value=""
                       required
                       data-validation="required"
                >
            </div>
        </td>
        <td>
            <div class="contactFirstName">

                <input name="form[contact][0][firstName]"
                       size="10"
                       maxlength="50"
                       value=""
                       required
                       data-validation="required"
                >
            </div>
        </td>
        <td>
            <div class="contactLast">

                <input name="form[contact][0][lastName]"
                       size="10"
                       maxlength="50"
                       value=""
                       required
                       data-validation="required"
                >
            </div>
        </td>
        <td>
            <div class="contactPosition">
                <input name="form[contact][0][position]"
                       value=""
                       size="10"
                       maxlength="50"
                />
            </div>
        </td>
        <td>
            <div class="contactPhone">

                <input name="form[contact][0][phone]"
                       value=""
                       size="10"
                       maxlength="30"
                >
            </div>
        </td>
        <td>
            <div class="contactMobile">
                <input name="form[contact][0][mobilePhone]"
                       value=""
                       size="10"
                       maxlength="30"
                >
            </div>
        </td>
        <td>
            <div class="contactEmail">
                <input type="email"
                       name="form[contact][0][email]"
                       value=""
                       size="25"
                       maxlength="60"
                       data-validation="emailOrEmpty server"
                       data-validation-url="/validateUniqueEmail.php"
                >
            </div>
        </td>
        <td>
            <div class="contactSupportLevel">
                <select name="form[contact][0][supportLevel]"
                        data-validation="atLeastOneMain"
                        data-type="mainSelector"
                        data-except="isReferred() || isProspect()"
                >
                    <!-- BEGIN templateSupportLevelBlock -->
                    <option value="{supportLevelValue}"
                    >
                        {supportLevelDescription}
                    </option>
                    <!-- END templateSupportLevelBlock -->
                </select>
            </div>
        </td>
        <td class="center ">
            <div class="contactPassword">
            </div>
        </td>
        <td>
            <div class="contactFailedLogins">
                <input name="form[contact][0][failedLoginCount]"
                       value=""
                       size="2"
                       maxlength="5"
                >
            </div>
        </td>
        <td>
            <div class="contactNotes">
                <input
                        name="form[contact][0][notes]"
                        size="5"
                        maxlength="200"
                        value=""
                />
            </div>
        </td>
        <td class="contactPendingLeaver">
            <div class="content">
                <i class="fab fa-linkedin-in"
                   style="color: red"
                   onclick="checkLink()"
                ></i>
                <input type="hidden"
                       name="form[contact][0][linkedInURL]"
                >
            </div>
        </td>
        <td>
            <div class="contactInitialLogging">

                <input type="checkbox"
                       name="form[contact][0][initialLoggingEmailFlag]"
                       value="Y"
                       class="checkboxAlign"
                       checked
                >
            </div>
        </td>
        <td>
            <div class="contactWorkStarted">

                <input type="checkbox"
                       name="form[contact][0][workStartedEmailFlag]"
                       value="Y"
                       class="checkboxAlign"
                       checked
                >
            </div>
        </td>
        <td>
            <div class="contactWorkUpdates">

                <input type="checkbox"
                       name="form[contact][0][workUpdatesEmailFlag]"
                       value="Y"
                       class="checkboxAlign"
                       checked
                >
            </div>
        </td>
        <td>
            <div class="contactFixed">

                <input type="checkbox"
                       name="form[contact][0][fixedEmailFlag]"
                       value="Y"
                       class="checkboxAlign"
                       checked
                >
            </div>
        </td>
        <td>
            <div class="contactPendingClosure">

                <input type="checkbox"
                       name="form[contact][0][pendingClosureEmailFlag]"
                       value="Y"
                       class="checkboxAlign"
                       checked
                >
            </div>
        </td>
        <td>
            <div class="contactClosure">

                <input type="checkbox"
                       name="form[contact][0][closureEmailFlag]"
                       value="Y"
                       class="checkboxAlign"
                       checked
                >
            </div>
        </td>
        <td>
            <div class="contactOthersInitialLogging">

                <input type="checkbox"
                       name="form[contact][0][othersInitialLoggingEmailFlag]"
                       value="Y"
                       disabled
                       class="onlyMain"
                >
            </div>
        </td>
        <td>
            <div class="contactOthersWorkStarted">
                <input type="checkbox"
                       name="form[contact][0][othersWorkStartedEmailFlag]"
                       value="Y"
                       disabled
                       class="onlyMain"
                >
            </div>
        </td>
        <td>
            <div class="contactOthersWorkUpdates">
                <input type="checkbox"
                       name="form[contact][0][othersWorkUpdatesEmailFlag]"
                       value="Y"
                       disabled
                       class="onlyMain"
                >
            </div>
        </td>
        <td>
            <div class="contactOthersFixed">
                <input type="checkbox"
                       name="form[contact][0][othersFixedEmailFlag]"
                       value="Y"
                       disabled
                       class="onlyMain"
                >
            </div>
        </td>
        <td>
            <div class="contactOthersPendingClosure">
                <input type="checkbox"
                       name="form[contact][0][othersPendingClosureEmailFlag]"
                       value="Y"
                       disabled
                       class="onlyMain"
                >
            </div>
        </td>
        <td>
            <div class="contactOthersClosure">
                <input type="checkbox"
                       name="form[contact][0][othersClosureEmailFlag]"
                       value="Y"
                       disabled
                       class="onlyMain"
                >
            </div>
        </td>
        <td>
            <div class="contactAccounts">

                <input type="checkbox"
                       name="form[contact][0][accountsFlag]"
                       value="Y"
                       data-validation="atLeastOne"
                       data-type="accounts"
                       data-except="isReferred() || isProspect()"
                />
            </div>
        </td>
        <td>
            <div class="contactMailshot2Flag">
                <input type="checkbox"
                       name="form[contact][0][mailshot2Flag]"
                       value="Y"
                       data-validation="atLeastOne"
                       data-type="invoice"
                       data-except="isReferred() || isProspect()"
                />
            </div>
        </td>
        <td>
            <div class="contactMailshot3Flag">
                <input type="checkbox"
                       name="form[contact][0][mailshot3Flag]"
                       value="Y"
                       checked
                />
            </div>
        </td>
        <td>
            <div class="contactMailshot4Flag">
                <input type="checkbox"
                       name="form[contact][0][mailshot4Flag]"
                       value="Y"
                       class="stmCheckBox"
                       data-validation="atLeastOneAtMostOne"
                       data-type="statement"
                       data-except="isReferred() || isProspect()"
                />
            </div>
        </td>

        <td>
            <div class="contactHR">
                <input type="checkbox"
                       name="form[contact][0][hrUser]"
                       value="Y"
                />
            </div>
        </td>

        <td>
            <div class="contactReview">
                <input type="checkbox"
                       name="form[contact][0][reviewUser]"
                       value="Y"
                       data-validation="atLeastOne"
                       data-type="review"
                       data-except="isReferred() || isProspect()"
                />
            </div>
        </td>
        <td>
            <div class="contactMailshot8Flag">
                <input type="checkbox"
                       name="form[contact][0][mailshot8Flag]"
                       value="Y"
                       data-type="topUp"
                       {topUpValidation}
                       data-except="isReferred() || isProspect()"
                />
            </div>
        </td>
        <td>
            <div class="contactMailshot11Flag">
                <input type="checkbox"
                       name="form[contact][0][mailshot11Flag]"
                       value="Y"
                       checked
                />
            </div>
        </td>
        <td>
            <div class="contactMailshot9Flag">
                <input type="checkbox"
                       name="form[contact][0][mailshot9Flag]"
                       value="Y"
                       data-validation="atLeastOne"
                       data-type="reports"
                       data-except="isReferred() || isProspect()"
                />
            </div>
        </td>
        <td>
            <div class="contactMailshot">
                <input type="checkbox"
                       name="form[contact][0][sendMailshotFlag]"
                       value="Y"
                       checked
                />
            </div>
        </td>
        <td nowrap="nowrap">
            <div class="contactLetters">
                <select name="letters_menu"
                        onchange="MM_jumpMenu('_blank',this,0)"
                >
                    <option>Send Letter</option>
                    <!-- BEGIN templateCustomLetterBlock -->
                    <option value="{customLetterURL}">{customLetterName}</option>
                    <!-- END templateCustomLetterBlock -->
                </select>
            </div>
        </td>
        <td>
            <div class="contactPendingLeaver">
                <input type="checkbox"
                       name="form[contact][0][pendingLeaverFlag]"
                       value="Y"
                />
            </div>
        </td>
        <td>
            <div class="contactPendingLeaverDate">
                <input type="date"
                       name="form[contact][0][pendingLeaverDate]"
                       value="{pendingLeaverDate}"
                       autocomplete="off"
                />
            </div>
        </td>
        <td class="contactSpecialAttention">
            <input type="checkbox"
                   name="form[contact][0][specialAttentionContactFlag]"
                   value="Y"
            >
        </td>
    </tr>
</script>
<script type="text/JavaScript">

    var isShowingInactive = false;

    function checkLink() {
        const iconElement = event.target;
        const input = iconElement.nextElementSibling;
        let URL = input.value;
        if (!URL) {
            URL = prompt("Please provide a LinkedIn URL for the contact");
            if (URL && !URL.match(/^https?:\/\/.*/)) {
                URL = "http://" + URL;
            }
            if (!URL) {
                return;
            }
            input.value = URL;
            iconElement.style.color = 'green';
            return;
        }

        window.open(URL, '_blank');
    }

    function checkWebsite() {
        let URL = $('#websiteURL').val();
        if (!URL) {
            URL = prompt("Please provide a Website URL for the customer");
            if (URL && !URL.match(/^https?:\/\/.*/)) {
                URL = "http://" + URL;
            }
            if (!URL) {
                return;
            }
            $('#websiteURL').val(URL);
            debugger;
            $('.fas.fa-globe')[0].style.color = 'green';
        }

        window.open(URL, '_blank');
    }

    function clearRow(contactID) {

        if (!confirm('Are you sure you want to delete this contact?')) {
            return;
        }
        var row = $(event.target).closest('tr');

        var object = {
            contactID: contactID
        };
        $.ajax({
            url: '?action=archiveContact',
            method: 'POST',
            type: 'post',
            dataType: 'json',
            data: object
        }).then(function (result) {
            if (result.status == 'error') {
                throw 'Failed to clear contact';
            } else {
                if (isShowingInactive) {
                    row.find('input[type="checkbox"]').attr('checked', false);
                    row.find('input[type="email"]').val(null);
                    row.find('select[data-type="mainSelector"]').val("").change();
                } else {
                    row.remove();
                }

            }
        }).catch(function (error) {
            alert('Failed to save password');
        });

    }

    function addContact(siteNo) {
        this.source = document.getElementById("contact-row").innerHTML;
        var context = {
            name: "a",
            id: 1,
            userID: 2
        };
        var html = Mustache.to_html(this.source, context);
        $(html)
            .find('select[name="form[contact][0][siteNo]"] option[value=' + siteNo + ']')
            .attr('selected', true)
            .end()
            .prependTo('#contactsTable tbody');
    }

    var currentContactId = null;
    var currentPasswordButton = null;

    function resetPasswordFields() {
        $('#password').val(null);
        $('#repeatPassword').val(null);
    }

    function cancelNewPassword() {
        $('#newPasswordDialog').dialog('close');
    }

    function saveNewPassword() {
        var object = {
            password: $('#password').val(),
            contactID: currentContactId
        };

        $.ajax({
            url: '?action=saveContactPassword',
            method: 'POST',
            type: 'post',
            dataType: 'json',
            data: object
        }).then(function (result) {
            if (result.status == 'error') {
                throw 'Failed to save password';
            } else {
                alert('Submitted OK');
                if ($(currentPasswordButton).hasClass('unlockedIcon')) {
                    $(currentPasswordButton).removeClass('unlockedIcon').addClass('lockedIcon');
                }
            }
        }).catch(function (error) {
            alert('Failed to save password');
            resetPasswordFields();
        }).then(function () {
            $('#newPasswordDialog').dialog('close');
        });
    }


    function askNewPassword() {
        var data = $(event.target).data();
        currentContactId = data.contactId;
        currentPasswordButton = event.target;
        $('#newPasswordDialog').dialog('open');
    }

    var validPassword = false;
    var validRepeatPassword = false;

    window.addEventListener('DOMContentLoaded', function () {

        CKEDITOR.replace('OpportunityDeal', {
                contentsCss: '/screen.css',
                toolbarStartupExpanded: false,
                disableNativeSpellChecker: false,

                toolbar: 'CNCToolbar',

                toolbar_CNCToolbar:
                    [
                        ['Source', '-', '-', 'Bold', 'Italic', 'Underline', 'Strike', 'TextColor', 'BGColor'],
                        ['NumberedList', 'BulletedList'],
                        ['Table'],
                        ['Format', 'Font', 'FontSize'],
                        ['Anchor', 'Link'],
                        ['Undo', 'Redo']
                    ],
                extraPlugins: 'font',
                fontSize_sizes: '8/8pt;9/9pt;10/10pt;11/11pt;12/12pt;14/14pt;16/16pt;18/18pt;20/20pt;22/22pt;24/24pt;26/26pt;28/28pt;36/36pt;48/48pt;72/72pt',
                height: '168px',
                width: '890px',
                extraAllowedContent: true,
                allowedContent: true,
                script: true
            }
        );
        CKEDITOR.config.disableNativeSpellChecker = false;
        CKEDITOR.config.removePlugins = 'liststyle,tabletools,scayt,menubutton,contextmenu,language,tableselection';

        $('#newPasswordDialog').dialog({
            autoOpen: false, width: 500, close: function () {
                resetPasswordFields();
            }
        });

        $('#password').keyup(function () {
            $('#passwordComment').html(checkStrength($('#password').val()));
            checkSavePassword();
        });

        $('#repeatPassword').keyup(function () {
            $('#repeatPasswordComment').html(checkPasswordEqual($('#password').val(), $('#repeatPassword').val()));
            checkSavePassword();
        });

        function checkSavePassword() {
            if (validPassword && validRepeatPassword) {
                $('#savePasswordButton').prop("disabled", false);
            } else {
                $('#savePasswordButton').prop("disabled", true);
            }
        }

        function checkPasswordEqual(password, repeatPassword) {
            validRepeatPassword = false;
            if (!password || !repeatPassword) {
                return null;
            }

            if (password != repeatPassword) {
                return 'Not Equal';
            }
            validRepeatPassword = true;
            return null;
        }

        function checkStrength(password) {
            validPassword = false;
            if (!password) {
                return false;
            }

            var strength = 0;
            if (password.length < 6) {
                return 'Too short'
            }

            if (password.match(/([a-z])/)) strength += 1;
            if (password.match(/([A-Z])/)) strength += 1;
            if (password.match(/([0-9])/)) strength += 1;
            if (password.match(/([!,%,&,@,#,$,^,*,?,_,~])/)) strength += 1;
// Calculated strength value, we can return messages
// If value is less than 2
            if (strength < 3) {
                $('#result').removeClass();
                $('#result').addClass('weak');
                return 'Weak'
            } else if (strength >= 3) {
                $('#result').removeClass();
                $('#result').addClass('good');
                validPassword = true;
                return null
            }
        }

        var config = {
            modules: 'security',
            inlineErrorMessageCallback: function (error, element) {

            },
            scrollToTopOnError: false
        };
        $.validate(config);

        $.formUtils.addValidator({
            name: 'emailOrEmpty',
            validatorFunction: function (email, $el) {

                if (email === '') {
                    return true;
                }

                var emailParts = email.toLowerCase().split('@'),
                    localPart = emailParts[0],
                    domain = emailParts[1];

                if (localPart && domain) {

                    if (localPart.indexOf('"') === 0) {
                        var len = localPart.length;
                        localPart = localPart.replace(/\"/g, '');
                        if (localPart.length !== (len - 2)) {
                            return false; // It was not allowed to have more than two apostrophes
                        }
                    }

                    if (!$.formUtils.validators.validate_domain.validatorFunction(emailParts[1]) &&
                        localPart.indexOf('.') !== 0 &&
                        localPart.substring(localPart.length - 1, localPart.length) !== '.' &&
                        localPart.indexOf('..') === -1 &&
                        !(/[^\w\+\.\-\#\-\_\~\!\$\&\'\(\)\*\+\,\;\=\:]/.test(localPart))
                    ) {
                        return false;
                    }


                    ///we need to check that no other email is set to the same
                    var test = $('input[data-validation*="emailOrEmpty"]');
                    var isDuplicate = false;

                    test.each(function () {
                        var elm = $(this);
                        var isMe = elm.get(0) === $el.get(0);

                        if (!isMe && elm.val().toLowerCase() === email.toLowerCase()) {
                            isDuplicate = true;
                            elm.addClass('error');
                            elm.parent().addClass('has-error');
                        }
                    });

                    return !isDuplicate;
                }

                return false;
            },
            errorMessage: '',
            errorMessageKey: 'badEmail'
        });

        const validatorData = {};

        $.formUtils.addValidator({
            name: 'atLeastOne',
            validatorFunction: function (value, $el, config, language, $form) {
                const elementData = $el.data();
                const dataType = elementData.type;
                var isValid = false;
                var except = elementData.except;
                var exceptCondition = false;
                if (except) {
                    exceptCondition = eval(except);
                }

                if (exceptCondition) {
                    return true;
                }

                if (validatorData.hasOwnProperty(dataType)) {
                    // there's an initiator...we should return whatever the initiator says
                    return validatorData[dataType];
                }

                var test = $('[data-type="' + dataType + '"]');

                var allElements = test.toArray();

                var counter = 0;

                do {
                    var elm = $(allElements[counter]);
                    isValid = !!elm.prop('checked');
                    counter++;
                } while (!isValid && counter < allElements.length);

                validatorData[dataType] = isValid;
                test.each(function () {
                    const elm = $(this);
                    const isMe = elm.get(0) === $el.get(0);
                    if (!isMe) {
                        elm.validate(null);
                    }
                });

                delete validatorData[dataType];
                return isValid;
            },
            errorMessage: '',
            errorMessageKey: 'atLeastOne'
        });

        $.formUtils.addValidator({
            name: 'atLeastOneAtMostOne',
            validatorFunction: function (value, $el, config, language, $form) {
                const elementData = $el.data();
                const dataType = elementData.type;
                var test = $('[data-type="' + dataType + '"]');
                var isValid = false;
                var except = elementData.except;
                var exceptCondition = false;
                if (except) {
                    exceptCondition = eval(except);
                }

                if (exceptCondition) {
                    return true;
                }

                if (validatorData.hasOwnProperty(dataType)) {
                    // there's an initiator...we should return whatever the initiator says
                    return validatorData[dataType];
                }

                var allElements = test.toArray();

                var counter = 0;
                var checkedCount = 0;
                do {
                    var elm = $(allElements[counter]);
                    checkedCount += !!elm.prop('checked');
                    counter++;
                } while (checkedCount < 2 && counter < allElements.length);

                isValid = checkedCount > 0 && checkedCount < 2;

                validatorData[dataType] = isValid;

                test.each(function () {
                    const elm = $(this);
                    const isMe = elm.get(0) === $el.get(0);
                    if (!isMe) {
                        elm.validate(null);
                    }
                });

                delete validatorData[dataType];
                // console.log('validating ' + dataType + " atLeastOneAtMostOne took " + (t1 - t0) + " milliseconds ");
                return isValid;
            },
            errorMessage: '',
            errorMessageKey: 'atLeastOne'
        });

        $.formUtils.addValidator({
            name: 'atLeastOneMain',
            validatorFunction: function (value, $el, config, language, $form) {
                var test = $('[data-type="' + $el.data().type + '"]');

                var checkedCount = 0;
                var except = test.data().except;
                var exceptCondition = eval(except);

                if (exceptCondition) {
                    return true;
                }

                test.each(function () {
                    var elm = $(this);
                    var isMe = elm.get(0) === $el.get(0);

                    if (elm.val() === 'main') {
                        checkedCount++;
                    }

                    if (!$el.data().toBeValidated && !isMe) {
                        elm.data("toBeValidated", true);
                        elm.validate();
                    }
                });
                $el.data("toBeValidated", false);

                return checkedCount > 0;
            }
        });


        var assignClass = function () {
            var elem = $(this);
            var tr = elem.closest('tr');


            if (elem[0].value === 'main' || elem[0].value === 'supervisor') {
                // we want to show the
                tr.find('.onlyMain').prop('disabled', false);
                if (elem[0].value === 'main') {
                    tr.addClass('redText');
                }
            } else {
                tr.find('.onlyMain').prop('disabled', true);
                tr.removeClass('redText');
            }
        };

        $('body').on('change', '[data-type="mainSelector"]', assignClass);

        $('[data-type="mainSelector"]').each(assignClass);

        var types = {};

        $('[data-validation="atLeastOne"], [data-validation="atLeastOneAtMostOne"]').each(function (index) {
            var $this = $(this);

            if (typeof types[$this.data().type] === 'undefined') {
                $this.validate();
                types[$this.data().type] = true;
            }
        });


        window.specialAttentionEndDate = $('#specialAttentionEndDate').get(0);
        window.lastReviewMeetingDate = $('#lastReviewMeetingDate').get(0);
        window.reviewDate = $('#reviewDate').get(0);
        window.meetingDate = $('#meetingDate').get(0);
    });
    window.onbeforeunload = bunload;

    function bunload() {
        if (customerNotesChanged) {
            return 'You haven\'t saved your notes';
        }
    }

    function setCaretPosition(elemId, caretPos) {
        var elem = document.getElementById(elemId);

        if (elem != null) {
            if (elem.createTextRange) {
                var range = elem.createTextRange();
                range.move('character', caretPos);
                range.select();
            } else {
                if (elem.selectionStart) {
                    elem.focus();
                    elem.setSelectionRange(caretPos, caretPos);
                } else
                    elem.focus();
            }
        }
    }

    var customerNotesChanged = false;

    function setCustomerNotesChanged() {

        customerNotesChanged = true;

    }

    function MM_jumpMenu(targ, selObj, restore) { //v3.0
        window.open(selObj.options[selObj.selectedIndex].value, targ);
        if (restore) selObj.selectedIndex = 0;
    }

    function loadNote(noteIdentifier) {

        var customerID = document.getElementById('customerID').value;

        if (customerID == 0) {
            return;
        }

        if (customerNotesChanged) {
            if (!confirm('You haven\'t saved your notes. Are you sure you want to move away?')) {
                return
            }
        }

        customerNotesChanged = false;

        var created = document.getElementById('customerNoteCreated').value;
        var url = "CustomerNote.php?action=getCustomerNote&customerID=" + customerID + "&created=" + created + "&identifier=" + noteIdentifier;

        loadXMLDoc(url);

    }

    function newNote() {

        var customerNoteID = document.getElementById('customerNoteID');
        var customerNoteOrdheadID = document.getElementById('customerNoteOrdheadID');
        var customerNoteDetails = document.getElementById('customerNoteDetails');
        var customerNoteModifiedText = document.getElementById('customerNoteModifiedText');

        customerNoteID.value = '';
        customerNoteOrdheadID.value = '';
        customerNoteDetails.value = '';
        customerNoteModifiedText.innerHTML = '';

    }

    function deleteNote() {
        var customerID = document.getElementById('customerID').value;
        var customerNoteID = document.getElementById('customerNoteID');

        if (customerNoteID.value == '') {
            return;
        }

        if (!confirm('Are you sure you want to delete this note?')) {
            return;
        }

        customerNotesChanged = false;

        var customerNoteDetails = document.getElementById('customerNoteDetails');
        var customerNoteModifiedText = document.getElementById('customerNoteModifiedText');

        var url = "CustomerNote.php?action=deleteCustomerNote&customerNoteID=" + customerNoteID.value;

        loadXMLDoc(url);

        customerNoteID.value = '';
        customerNoteDetails.value = '';
        customerNoteModifiedText.innerHTML = 'Note Deleted';

    }

    function isProspect() {
        return "{becameCustomerDate}" && !"{droppedCustomerDate}";
    }

    function isReferred() {
        return {referred};
    }


    function saveNote() {

        var customerID = document.getElementById('customerID').value;

        if (customerID == 0) {
            return;
        }

        var customerNoteID = document.getElementById('customerNoteID').value;
        var customerNoteOrdheadID = document.getElementById('customerNoteOrdheadID').value;
        var details = encodeURIComponent(document.getElementById('customerNoteDetails').value);

        var url = "CustomerNote.php?action=updateNote&customerNoteID=" +
            customerNoteID + "&ordheadID=" + customerNoteOrdheadID + "&customerID=" + customerID + "&details=" + details;

        customerNotesChanged = false;

        loadXMLDoc(url);

    }

    function contactPopup(contactID, action, customerID, siteNo) {
        window.open(
            '{urlContactPopup}' +
            '&action=' + action +
            '&contactID=' + contactID +
            '&customerID=' + customerID +
            '&siteNo=' + siteNo +
            '&parentIDField=none' +
            '&parentDescField=none',
            'contact',
            'scrollbars=yes,resizable=yes,height=700,width=500,copyhistory=no, menubar=0'
        );
    }


    function checkMailShotOptions() {
        window.event.preventDefault();
        debugger;
        document.customerReviewComponent.save()
            .then(() => {
                debugger;
                if (validateData()) {
                    window.event.target.submit();
                }
            })
        return false;
    }

    function validateData() {
        const emails = {};

        const inputs = $(".contacts input[type='email']");
        for (let i = 0; i < inputs.length; i++) {
            if (inputs[i].value) {
                const email = inputs[i].value;

                if (emails[email]) {
                    alert('Please review form errors, fix them before submitting');
                    return false;
                }

                emails[email] = true;
            }

        }

        var x = document.getElementsByClassName('stmCheckBox');

        var count = 0;
        var i = 0;
        do {
            if (x[i].checked) {
                count++;
            }

            i++;
        } while (count < 2 && i < x.length);

        if (count > 1) {
            alert('There cannot be more than one "stm" option selected');
            return false
        }

        const value = +$('#primaryMainContactID').val();

        if (value && !isProspect()) {
            const mainContactsSelect = $('.contactSupportLevel select option:selected[value="main"]').parent('select');

            let foundMain = false;

            mainContactsSelect.each(function () {
                const foundMatch = $(this).attr('name').match(/\d+/);
                if (foundMatch && foundMatch[0] == value) {
                    foundMain = true;
                }
            });

            if (!foundMain) {
                alert("The Primary Main contact is no longer flagged as Main, please flag it back or pick another Main Contact as Primary");
                return false;
            }
        }

        return true;
    }

    window.addEventListener('DOMContentLoaded', function () {
        console.log('register event listener...');
        document.querySelector('form[name="form"]')
            .addEventListener(
                'submit',
                ($event) => {
                    console.log('submit !!');

                })
    })
    //-->
</script>
<link rel="stylesheet"
      href="/font-awesome/css/font-awesome.css"
/>
<style>
    textarea {
        padding: 8px;
        margin: 0;
        border-radius: 3px;
        margin-bottom: 5px;
    }

    .customerNoteNav {
        background: #f4f4f2;
        border: 1px solid #999;
        width: 745px;
        margin-left: 5px;
        margin-bottom: 20px;
        padding: 4px;
    }

    .customerNoteNav a {
        display: inline-block;
        color: #111;
        text-decoration: underline;
        font-size: 13px;
        margin-left: 3px;
    }

    .float-right {
        text-align: right;
        float: right
    }

    .contacts {
        margin-bottom: 30px;
    }

    #col1 {
        width: 360px;
        min-height: 500px;
        float: left;
        margin-right: 20px;
    }

    #col2 {
        width: 570px;
        min-height: 500px;
        float: left;
        margin-right: 15px;
    }

    #col3 {
        width: 570px;
        min-height: 500px;
        float: left;
        margin-right: 15px;
    }

    #col1 .site {
        margin-bottom: 25px;
    }

    #col2 .cke, #col3 .cke {
        width: 550px !important;
        margin-bottom: 20px;
    }

    #col1 .label, #col2 .label, #col3 .label {
        padding-bottom: 10px;
        font-size: 14px;
    }

    .customerNoteHistory {
        margin-bottom: 20px !important;
    }

    #customerNoteModifiedText_holder {
        margin-left: 6px;
        font-size: 14px;
    }

    #customerNoteModifiedText {
        display: inline-block;
    }

    #textareas {
        float: left;
        min-width: 500px;
        width: 1060px;
    }

    #textareas .textarea {
        float: left;
        margin-right: 20px;
        min-height: 50px;
        width: 500px;
        max-width: 530px;
    }

    .cke {
        width: 500px !important;
        margin-bottom: 15px;
    }

    .textarea .label {
        line-height: 26px;
        font-size: 14px;
    }

    @media screen and (max-width: 1600px) {
        #textareas {
            width: 530px;
        }
    }

    table.content tbody td {
        background-color: #F4f4f2;
        text-align: left;
        padding: 5px;
        vertical-align: top;
        white-space: nowrap;
    }

    table.content tbody td.center {
        text-align: center;
    }

    .contactError input {
        border-color: red;
    }

    td.has-error {
        background-color: red !important;
    }

    .redText td input, .redText td textarea, .redText td select, .redText td button {
        color: red !important;
    }

    .lockedIcon::before {
        font-family: "FontAwesome";
        content: '\f023';
        color: green;
    }

    .unlockedIcon::before {
        font-family: "FontAwesome";
        content: '\f13e';
        color: red;
    }

    fieldset label {
        height: 20px;
        width: 140px;
        margin-left: 10px;
        text-align: right;
        clear: both;
        float: left;
        margin-right: 15px;
        margin-top: 10px;
    }

    fieldset input {
        height: 20px;
        width: 200px;
        border: 1px solid #000;
        margin-top: 10px;
        float: left;
    }

    fieldset .comment {
        float: left;
        margin-top: 10px;
    }

    table.content tbody td {
        background-color: #F4f4f2;
        text-align: left;
        padding: 5px;
        vertical-align: top;
        white-space: nowrap;
    }

    table.content thead td {
        padding: 5px;
    }

    table.content tbody td.center {
        text-align: center;
    }

    .contactError input {
        border-color: red;
    }

    .lockedIcon::before {
        font-family: "FontAwesome";
        content: '\f023';
        color: green;
    }

    .unlockedIcon::before {
        font-family: "FontAwesome";
        content: '\f13e';
        color: red;
    }

    div.has-error {
        background-color: red !important;
    }

    fieldset label {
        height: 20px;
        width: 140px;
        margin-left: 10px;
        text-align: right;
        clear: both;
        float: left;
        margin-right: 15px;
        margin-top: 10px;
    }

    fieldset input {
        height: 20px;
        width: 200px;
        border: 1px solid #000;
        margin-top: 10px;
        float: left;
    }

    fieldset .comment {
        float: left;
        margin-top: 10px;
    }

    .redText td input, .redText td textarea, .redText td select, .redText td button {
        color: red !important;
    }

    .highlight {
        background-color: lightgreen;
    }

    .contactClear {
        width: 26px;
    }

    .contactSite {
        width: 40px;
    }

    .contactTitle {
        width: 52px;
    }

    .contactFirstName {
        width: 100px;
    }

    .contactLast {
        width: 100px;
    }

    .contactPosition {
        width: 100px;
    }

    .contactPhone {
        width: 100px;
    }

    .contactMobile {
        width: 100px;
    }

    .contactEmail {
        width: 190px;
    }

    .contactPassword {
        width: 60px;
    }

    .contactFailedLogins {
        width: 50px;
    }

    .contactNotes {
        width: 80px;
    }

    .contactInitialLogging {
        width: 50px;
    }

    .contactWorkStarted {
        width: 50px;
    }

    .contactWorkUpdates {
        width: 50px;
    }

    .contactFixed {
        width: 50px;
    }

    .contactPendingClosure {
        width: 50px;
    }

    .contactClosure {
        width: 50px;
    }

    .contactOthersInitialLogging {
        width: 50px;
    }

    .contactOthersWorkStarted {
        width: 50px;
    }

    .contactOthersWorkUpdates {
        width: 50px;
    }

    .contactOthersFixed {
        width: 50px;
    }

    .contactOthersPendingClosure {
        width: 50px;
    }

    .contactOthersClosure {
        width: 50px;
    }

    .contactAccounts {
        width: 50px;
    }

    .contactMailshot2Flag {
        width: 50px;
    }

    .contactMailshot3Flag {
        width: 50px;
    }

    .contactMailshot4Flag {
        width: 50px;
    }

    .contactSupportLevel {
        width: 90px;
    }

    .contactHR {
        width: 50px;
    }

    .contactReview {
        width: 50px;
    }

    .contactMailshot8Flag {
        width: 50px;
    }

    .contactMailshot11Flag {
        width: 50px;
    }

    .contactMailshot9Flag {
        width: 50px;
    }

    .contactMailshot {
        width: 50px;
    }

    .contactLetters {
        width: 290px;
    }

    .contactPendingLeaver {
        width: 50px;
    }

    .contactPendingLeaverDate {
        width: 160px;
    }


</style>
<span class="formError">{errorMessage}</span>
<form name="form"
      method="post"
      action="{submitURL}"
      AUTOCOMPLETE="off"
      onsubmit="return checkMailShotOptions()"
>
    <button {disabled}
            name="Go"
    ><i class="fa fa-floppy-o"
        aria-hidden="true"
    ></i> Save
    </button>
    <button {disabled}
            name="Button"
            onClick="document.location='{cancelURL}';"
    ><i class="fa fa-ban"
        aria-hidden="true"
    ></i> Cancel
    </button>
    <input type="hidden"
           id="customerID"
           name="form[customer][{customerID}][customerID]"
           value="{customerID}"
    >
    <input type="hidden"
           name="form[customer][{customerID}][createDate]"
           value="{createDate}"
    >
    <input type="hidden"
           name="form[customer][{customerID}][regNo]"
           value="{regNo}"
           size="10"
           maxlength="10"
    >
    <input type="hidden"
           name="form[customer][{customerID}][name]"
           value="{customerName}"
    >
    <input type="hidden"
           id="websiteURL"
           name="form[customer][{customerID}][websiteURL]"
           value="{websiteURL}"
    >
    <input name="form[customer][{customerID}][gscTopUpAmount]"
           type="hidden"
           value="{gscTopUpAmount}"
    >
    <input name="customerNoteID"
           id="customerNoteID"
           type="hidden"
           value="{customerNoteID}"
    >
    <input name="customerNoteOrdheadID"
           id="customerNoteOrdheadID"
           type="hidden"
           value="{customerNoteOrdheadID}"
    >
    <input name="customerNoteCreated"
           id="customerNoteCreated"
           type="hidden"
           value="{customerNoteCreated}"
    >
    <input name="customerNoteModified"
           id="customerNoteModified"
           type="hidden"
           value="{customerNoteModified}"
    >
    <input name="form[customer][{customerID}][reviewMeetingEmailSentFlag]"
           id="reviewMeetingEmailSentFlag"
           type="hidden"
           value="{reviewMeetingEmailSentFlag}"
    >
    <input type="hidden"
           name="form[customer][{customerID}][primaryMainContactID]"
           id="primaryMainContactID"
           value="{primaryMainContactID}"
    >

    <BR/>
    <BR/>
    <div style="display: flex;flex-direction: row;justify-content: space-between; width: 1237px">
        <div>
            <h3 style="clear: both;">Site Information</h3>
            <DIV class="site">

                <input type="hidden"
                       name="form[site][{customerID}{siteNo}][sageRef]"
                       value="{sageRef}"
                >
                <input type="hidden"
                       name="form[site][{customerID}{siteNo}][siteNo]"
                       value="{siteNo}"
                >
                <input type="hidden"
                       name="form[site][{customerID}{siteNo}][customerID]"
                       value="{customerID}"
                >
                <input type="hidden"
                       name="form[site][{customerID}{siteNo}][debtorCode]"
                       value="{debtorCode}"
                >
                <input type="hidden"
                       name="form[site][{customerID}{siteNo}][activeFlag]"
                       value="{activeFlag}"
                >
                <input type="hidden"
                       name="form[site][{customerID}{siteNo}][maxTravelHours]"
                       value="{maxTravelHours}"
                >
                <input type="hidden"
                       name="form[site][{customerID}{siteNo}][deliverContactID]"
                       value="{deliverContactID}"
                >
                <input type="hidden"
                       name="form[site][{customerID}{siteNo}][nonUKFlag]"
                       value="{nonUKFlag}"
                >

                <table class="content"
                       border="0"
                       cellpadding="2"
                       cellspacing="1"
                       width="10%"
                >
                    <tr>
                        <td class="content"
                            width="13%"
                        >Site Address
                        </td>
                        <td class="content"
                            width="87%"
                        >
                            <input {disabled}
                                   name="form[site][{customerID}{siteNo}][add1]"
                                   value="{add1}"
                                   size="35"
                                   maxlength="35"
                            ></td>
                    </tr>
                    <tr>
                        <td class="content">&nbsp;</td>
                        <td class="content">
                            <input {disabled}
                                   name="form[site][{customerID}{siteNo}][add2]"
                                   value="{add2}"
                                   size="35"
                                   maxlength="35"
                            ></td>
                    </tr>
                    <tr>
                        <td class="content">&nbsp;</td>
                        <td class="content">
                            <input {disabled}
                                   name="form[site][{customerID}{siteNo}][add3]"
                                   value="{add3}"
                                   size="35"
                                   maxlength="35"
                            /></td>
                    </tr>
                    <tr>
                        <td class="content">Town</td>
                        <td class="content">
                            <input {disabled}
                                   name="form[site][{customerID}{siteNo}][town]"
                                   value="{town}"
                                   size="25"
                                   maxlength="25"
                            ></td>
                    </tr>
                    <tr>
                        <td class="content">County</td>
                        <td class="content">
                            <input {disabled}
                                   name="form[site][{customerID}{siteNo}][county]"
                                   value="{county}"
                                   size="25"
                                   maxlength="25"
                            ></td>
                    </tr>
                    <tr>
                        <td class="content">Postcode</td>
                        <td class="content">
                            <input {disabled}
                                   name="form[site][{customerID}{siteNo}][postcode]"
                                   value="{postcode}"
                                   size="15"
                                   maxlength="15"
                            ></td>
                    </tr>
                    <tr>
                        <td class="content">Phone</td>
                        <td class="content">
                            <input {disabled}
                                   name="form[site][{customerID}{siteNo}][sitePhone]"
                                   value="{sitePhone}"
                                   size="35"
                                   maxlength="35"
                            >
                        </td>
                    </tr>
                    <tr>
                        <td colspan="2"
                            class="content"
                        >
                            <button type="button"
                                    onclick="addContact({siteNo})"
                            >
                                Add Contact
                            </button>
                        </td>
                    </tr>

                    <!--<tr>-->
                    <!--<td colspan="2" class="content">-->
                    <!--<a href="javascript:" onclick="contactPopup(0, 'addContact', {customerID}, {siteNo} )">{addContactText}</a>-->
                    <!--</td>-->
                    <!--</tr>-->

                </table>
            </div> <!-- site -->
        </div>
        <div>
            <h3 style="clear: both;">Lead Information</h3>
            <table class="content"
                   style="width: 346px"
            >
                <tr>
                    <td class="content">
                        <div class="content">Lead Status</div>
                    </td>
                    <td class="content">
                        <select
                                name="form[customer][{customerID}][leadStatusId]"
                        >
                            <option>-- Pick an Option --</option>
                            <!-- BEGIN customerLeadStatusBlock -->
                            <option {customerLeadStatusSelected}
                                    value="{customerLeadStatusId}"
                            >
                                {customerLeadStatusName}
                            </option>
                            <!-- END customerLeadStatusBlock -->
                        </select>
                    </td>
                </tr>
                <tr>
                    <td class="content">
                        <div class="content">Email Opt Out</div>
                    </td>
                    <td class="content"><input type="checkbox"
                                               name="form[customer][{customerID}][mailshotFlag]"
                                               value="Y"
                                               {mailshotFlagChecked}
                    /></td>
                </tr>
                <tr>
                    <td class="content"><label for="dateMeetingConfirmed"
                                               class="content"
                    >Meeting Confirmed</label></td>
                    <td class="content"><input {disabled}
                                               type="date"
                                               name="form[customer][{customerID}][dateMeetingConfirmedDate]"
                                               id="dateMeetingConfirmed"
                                               value="{dateMeetingConfirmedDate}"
                    ></td>
                </tr>
                <tr>
                    <td class="content"><label for="meetingDateTime"
                                               class="content"
                    >
                        Meeting Date
                    </label></td>
                    <td class="content"><input {disabled}
                                               type="datetime-local"
                                               name="form[customer][{customerID}][meetingDateTime]"
                                               id="meetingDateTime"
                                               value="{meetingDateTime}"
                                               size="10"
                                               maxlength="10"
                    ></td>
                </tr>
                <tr>
                    <td class="content">
                        <div class="content">Invite Sent</div>
                    </td>
                    <td class="content"><input type="checkbox"
                                               name="form[customer][{customerID}][InviteSent]"
                                               value="Y"
                                               {InviteSent}
                    /></td>
                </tr>
                <tr>
                    <td class="content">
                        <div class="content">Report Processed</div>
                    </td>
                    <td class="content"><input type="checkbox"
                                               name="form[customer][{customerID}][ReportProcessed]"
                                               value="Y"
                                               {ReportProcessed}
                    /></td>
                </tr>
                <tr>
                    <td class="content">
                        <div class="content">Report Sent</div>
                    </td>
                    <td class="content"><input type="checkbox"
                                               name="form[customer][{customerID}][ReportSent]"
                                               value="Y"
                                               {ReportSent}
                    />
                    </td>
                </tr>
                <tr>
                    <td class="content">
                        <div class="content">Rating</div>
                    </td>
                    <td class="content"><input type="number"
                                               value="{Rating}"
                                               name="form[customer][{customerID}][Rating]"
                    >
                    </td>
                </tr>
            </table>
        </div>
        <div>
            <h3 style="clear: both;">Opportunity Deal</h3>
            <textarea name="form[customer][{customerID}][opportunityDeal]"
                      id="OpportunityDeal"
            >{opportunityDeal}</textarea>
        </div>
    </div>
    <br/>
    <div>
        <h3 style="clear: both;">Contacts</h3>
        <div class="contacts"
             id="contactsTable"
        >
            <table class="content fixed_header"
                   border="0"
                   cellpadding="2"
                   cellspacing="1"
            >
                <thead>
                <tr>
                    <td class="headerLightgrey">
                        <div class="contactClear">
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactSite">
                            Site
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactTitle">
                            Title
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactFirstName">
                            First
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactLast">
                            Last
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactPosition">
                            Position
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactPhone">
                            Phone
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactMobile">
                            Mobile
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactEmail">
                            Email
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactSupportLevel">
                            Support Level
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactPassword">
                            Password
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactFailedLogins">
                            Failed Logins
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactNotes">
                            Notes
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactPendingLeaver">
                            LinkedIn
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactInitialLogging">
                            Initial Logging?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactWorkStarted">
                            Work Started?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactWorkUpdates">
                            Work Updates?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactFixed">
                            Fixed?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactPendingClosure">
                            Pending Closure?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactClosure">
                            Closure?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactOthersInitialLogging">
                            Others Initial Logging?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactOthersWorkStarted">
                            Others Work Started?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactOthersWorkUpdates">
                            Others Work Updates?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactOthersFixed">
                            Others Fixed?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactOthersPendingClosure">
                            Others Pending Closure?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactOthersClosure">
                            Others Closure?
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactAccounts">
                            Accounts
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactMailshot2Flag">
                            {mailshot2FlagDesc}
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactMailshot3Flag">
                            {mailshot3FlagDesc}
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactMailshot4Flag">
                            {mailshot4FlagDesc}
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactHR">
                            HR
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactReview">
                            Review
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactMailshot8Flag">
                            {mailshot8FlagDesc}
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactMailshot11Flag">
                            {mailshot11FlagDesc}
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactMailshot9Flag">
                            {mailshot9FlagDesc}
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactMailshot">
                            Mailshot
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactLetters">
                            Letters
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactPendingLeaver">
                            Pending Leaver
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactPendingLeaverDate">
                            Pending Leaver Date
                        </div>
                    </td>
                    <td class="headerLightgrey">
                        <div class="contactPendingLeaver">
                            Special Attention
                        </div>
                    </td>
                </tr>
                </thead>
                <tbody>
                <!-- BEGIN contactBlock -->
                <input type="hidden"
                       name="form[contact][{contactID}][contactID]"
                       value="{contactID}"
                >
                <input type="hidden"
                       name="form[contact][{contactID}][customerID]"
                       value="{customerID}"
                >
                <input type="hidden"
                       name="form[contact][{contactID}][supplierID]"
                       value="{supplierID}"
                >
                <input type="hidden"
                       name="form[contact][{contactID}][fax]"
                       value="{fax}"
                >
                <input type="hidden"
                       name="form[contact][{contactID}][discontinuedFlag]"
                       value="{discontinuedFlag}"
                >
                <tr>
                    <td>
                        <div class="contactClear">
                            <button type="button"
                                    onclick="clearRow({contactID})"
                            >
                                <i class="fal fa-trash-alt"></i>
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="contactSite">
                            <select
                                    name="form[contact][{contactID}][siteNo]"
                                    data-validation="required"
                            >
                                <!-- BEGIN selectSiteBlock -->
                                <option {siteSelected}
                                        value="{selectSiteNo}"
                                >{selectSiteDesc}
                                </option>
                                <!-- END selectSiteBlock -->
                            </select>
                        </div>
                    </td>
                    <td class="{titleClass} ">
                        <div class="contactTitle">

                            <input {disabled}
                                   name="form[contact][{contactID}][title]"
                                   size="2"
                                   maxlength="10"
                                   value="{title}"
                                   required
                                   data-validation="required"
                            >
                        </div>
                    </td>
                    <td class='{firstNameClass} '>
                        <div class="contactFirstName">

                            <input {disabled}
                                   name="form[contact][{contactID}][firstName]"
                                   size="10"
                                   maxlength="50"
                                   value="{firstName}"
                                   required
                                   data-validation="required"
                            >
                        </div>
                    </td>
                    <td class='{lastNameClass} '>
                        <div class="contactLast">

                            <input {disabled}
                                   name="form[contact][{contactID}][lastName]"
                                   size="10"
                                   maxlength="50"
                                   value="{lastName}"
                                   required
                                   data-validation="required"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactPosition">

                            <input name="form[contact][{contactID}][position]"
                                   id="form[contact][{contactID}][position]"
                                   value="{position}"
                                   size="10"
                                   maxlength="20"
                                   {disabled}
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactPhone">

                            <input {disabled}
                                   name="form[contact][{contactID}][phone]"
                                   value="{phone}"
                                   size="10"
                                   maxlength="30"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactMobile">

                            <input {disabled}
                                   name="form[contact][{contactID}][mobilePhone]"
                                   value="{mobilePhone}"
                                   size="10"
                                   maxlength="30"
                            >
                        </div>
                    </td>
                    <td class='{emailClass} '>
                        <div class="contactEmail">

                            <input {disabled}
                                   type="email"
                                   name="form[contact][{contactID}][email]"
                                   value="{email}"
                                   size="25"
                                   maxlength="50"
                                   data-validation="emailOrEmpty server"
                                   data-validation-url="/validateUniqueEmail.php"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactSupportLevel">

                            <select name="form[contact][{contactID}][supportLevel]"
                                    data-validation="atLeastOneMain"
                                    data-type="mainSelector"
                                    data-except="isReferred() || isProspect()"
                            >
                                <!-- BEGIN supportLevelBlock -->
                                <option {supportLevelSelected}
                                        data-test="{supportLevelSelected}"
                                        value="{supportLevelValue}"
                                >
                                    {supportLevelDescription}
                                </option>
                                <!-- END supportLevelBlock -->
                            </select>
                        </div>
                    </td>
                    <td class="center ">
                        <div class="contactPassword">

                            <button onclick="askNewPassword()"
                                    data-contact-id="{contactID}"
                                    type="button"
                                    class="{portalPasswordButtonClass}"
                            >
                            </button>
                        </div>
                    </td>
                    <td>
                        <div class="contactFailedLogins">

                            <input {disabled}
                                   name="form[contact][{contactID}][failedLoginCount]"
                                   value="{failedLoginCount}"
                                   size="2"
                                   maxlength="5"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactNotes">

                            <input {disabled}
                                   name="form[contact][{contactID}][notes]"
                                   size="5"
                                   maxlength="200"
                                   value="{notes}"
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactPendingLeaver">
                            <i class="fab fa-linkedin-in"
                               style="color: {linkedInColor}"
                               onclick="checkLink()"
                            ></i>
                            <input type="hidden"
                                   name="form[contact][{contactID}][linkedInURL]"
                                   value="{linkedInURL}"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactInitialLogging">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][initialLoggingEmailFlag]"
                                   value="Y"
                                   {initialLoggingEmailFlagChecked}
                                   class="checkboxAlign"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactWorkStarted">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][workStartedEmailFlag]"
                                   value="Y"
                                   {workStartedEmailFlagChecked}
                                   class="checkboxAlign"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactWorkUpdates">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][workUpdatesEmailFlag]"
                                   value="Y"
                                   {workUpdatesEmailFlagChecked}
                                   class="checkboxAlign"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactFixed">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][fixedEmailFlag]"
                                   value="Y"
                                   {fixedEmailFlagChecked}
                                   class="checkboxAlign"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactPendingClosure">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][pendingClosureEmailFlag]"
                                   value="Y"
                                   {pendingClosureEmailFlagChecked}
                                   class="checkboxAlign"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactClosure">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][closureEmailFlag]"
                                   value="Y"
                                   {closureEmailFlagChecked}
                                   class="checkboxAlign"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactOthersInitialLogging">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][othersInitialLoggingEmailFlag]"
                                   value="Y"
                                   {othersInitialLoggingEmailFlagChecked}
                                   disabled
                                   class="onlyMain"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactOthersWorkStarted">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][othersWorkStartedEmailFlag]"
                                   value="Y"
                                   {othersWorkStartedEmailFlagChecked}
                                   disabled
                                   class="onlyMain"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactOthersWorkUpdates">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][othersWorkUpdatesEmailFlag]"
                                   value="Y"
                                   {othersWorkUpdatesEmailFlagChecked}
                                   disabled
                                   class="onlyMain"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactOthersFixed">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][othersFixedEmailFlag]"
                                   value="Y"
                                   {othersFixedEmailFlagChecked}
                                   disabled
                                   class="onlyMain"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactOthersPendingClosure">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][othersPendingClosureEmailFlag]"
                                   value="Y"
                                   {othersPendingClosureEmailFlagChecked}
                                   disabled
                                   class="onlyMain"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactOthersClosure">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][othersClosureEmailFlag]"
                                   value="Y"
                                   {othersClosureEmailFlagChecked}
                                   disabled
                                   class="onlyMain"
                            >
                        </div>
                    </td>
                    <td>
                        <div class="contactAccounts">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][accountsFlag]"
                                   value="Y"
                                   {accountsFlagChecked}
                                   data-validation="atLeastOne"
                                   data-type="accounts"
                                   data-except="isReferred() || isProspect() "
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactMailshot2Flag">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][mailshot2Flag]"
                                   value="Y"
                                   {mailshot2FlagChecked}
                                   data-validation="atLeastOne"
                                   data-type="invoice"
                                   data-except="isReferred() || isProspect()"
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactMailshot3Flag">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][mailshot3Flag]"
                                   value="Y"
                                   {mailshot3FlagChecked}
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactMailshot4Flag">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][mailshot4Flag]"
                                   value="Y"
                                   {mailshot4FlagChecked}
                                   class="stmCheckBox"
                                   data-validation="atLeastOneAtMostOne"
                                   data-type="statement"
                                   data-except="isReferred() || isProspect()"
                            />
                        </div>
                    </td>

                    <td>
                        <div class="contactHR">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][hrUser]"
                                   value="Y"
                                   {hrUserFlagChecked}
                            />
                        </div>
                    </td>

                    <td>
                        <div class="contactReview">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][reviewUser]"
                                   value="Y"
                                   {reviewUserFlagChecked}
                                   data-validation="atLeastOne"
                                   data-type="review"
                                   data-except="isReferred() || isProspect()"
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactMailshot8Flag">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][mailshot8Flag]"
                                   value="Y"
                                   {mailshot8FlagChecked}
                                   data-type="topUp"
                                   {topUpValidation}
                                   data-except="isReferred() || isProspect()"
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactMailshot11Flag">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][mailshot11Flag]"
                                   value="Y"
                                   {mailshot11FlagChecked}
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactMailshot9Flag">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][mailshot9Flag]"
                                   value="Y"
                                   {mailshot9FlagChecked}
                                   data-validation="atLeastOne"
                                   data-type="reports"
                                   data-except="isReferred() || isProspect()"
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactMailshot">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][sendMailshotFlag]"
                                   value="Y"
                                   {sendMailshotFlagChecked}
                            />
                        </div>
                    </td>
                    <td nowrap="nowrap">
                        <div class="contactLetters">

                            <select {disabled}
                                    name="letters_menu"
                                    onchange="MM_jumpMenu('_blank',this,0)"
                            >
                                <option>Send Letter</option>
                                <option value="{clientFormURL}">Appointment</option>
                                <!-- BEGIN customLetterBlock -->
                                <option value="{customLetterURL}">{customLetterName}</option>
                                <!-- END customLetterBlock -->
                            </select>
                        </div>
                    </td>
                    <td>
                        <div class="contactPendingLeaver">

                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][pendingLeaverFlag]"
                                   value="Y"
                                   {pendingLeaverFlagChecked}
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactPendingLeaverDate">

                            <input {disabled}
                                   type="date"
                                   name="form[contact][{contactID}][pendingLeaverDate]"
                                   value="{pendingLeaverDate}"
                                   autocomplete="off"
                            />
                        </div>
                    </td>
                    <td>
                        <div class="contactPendingLeaver">
                            <input {disabled}
                                   type="checkbox"
                                   name="form[contact][{contactID}][specialAttentionContactFlag]"
                                   value="Y"
                                   {specialAttentionContactFlagChecked}
                            >
                        </div>
                    </td>
                </tr>

                <!-- END contactBlock -->
                </tbody>
            </table>
        </div>
    </div>
</form>
<div class="customerEditMainRightColumn">
    <div id="reactCustomerReviewSection"
         data-customer-id="{customerID}"
    ></div>
    <div id="reactCustomerNotes"
         data-customer-id="{customerID}"
    ></div>
    <div>
        {lastContractSent}
    </div>
</div> <!-- customerEditMainRightColumn -
