<style>
    .pending td {
        color: red;
    }
</style>
<script>
    let expensesTable = null;
    let overtimeTable = null;

    function approveExpense(expenseId) {
        fetch("?action=approveExpense&id=" + expenseId)
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    return alert(data.error);
                }
                expensesTable.ajax.reload();
            })
    }

    function denyExpense(expenseId) {
        const reason = prompt("Please provide a reason for denying this expense");
        if (!reason) {
            return alert('Reason cannot be empty');
        }
        fetch("?action=denyExpense&id=" + expenseId + "&denyReason=" + reason)
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    return alert(data.error);
                }
                expensesTable.ajax.reload();
            })

    }

    function deleteExpense(expenseId) {
        if (!confirm('Are you sure you want to delete this expense?')) {
            return;
        }

        fetch("?action=deleteExpense&id=" + expenseId)
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    return alert(data.error);
                }
                expensesTable.ajax.reload();
            })
    }

    function approveOvertime(expenseId) {
        fetch("?action=approveOvertime&id=" + expenseId)
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    return alert(data.error);
                }
                overtimeTable.ajax.reload();
            })
    }

    function denyOvertime(expenseId) {
        const reason = prompt("Please provide a reason for denying this overtime");
        if (!reason) {
            return alert('Reason cannot be empty');
        }
        fetch("?action=denyOvertime&id=" + expenseId + "&denyReason=" + reason)
            .then(response => {
                return response.json();
            })
            .then(data => {
                if (data.error) {
                    return alert(data.error);
                }
                overtimeTable.ajax.reload();
            })
    }

    $(function () {
        expensesTable = $('#expensesTable').DataTable({
            dom: 'lfrtip',
            columns: [
                {data: "staffName", name: 'staffName'},
                {
                    data: "serviceRequestId", name: "serviceRequestId", render: (data, type, row, meta) => {
                        return '<a href="Activity.php?action=displayActivity&callActivityID=' + row.activityId + '" target="_blank">' + data + '</a>';
                    }
                },
                {
                    data: 'customerName',
                    name: 'customerName'
                },
                {
                    data: "dateSubmitted", name: "dateSubmitted", render: (data) => {
                        if (!data) {
                            return null;
                        }
                        return moment(data, "YYYY-MM-DD HH:mm:ss").format('DD/MM/YYYY');
                    }
                },
                {
                    data: "expenseTypeDescription", name: "expenseTypeDescription", render: (data, type, row) => {
                        if (!row.receiptId) {

                            if (row.receiptRequired) {
                                return data + " *Receipt Missing*";
                            }

                            return data;
                        }

                        return data + " <a href='/Receipt.php?action=show&receiptID=" + row.receiptId + "' target='_blank' >(Receipt)</a>"
                    }
                },
                {
                    data: "value", name: "value", render: (data) => {
                        if (!+data) {
                            return null;
                        }
                        return "&pound;" + data.toFixed(2);
                    }
                },
                {data: "projectDescription", name: "projectDescription"},
                {
                    data: "approvedDate", name: "approvedDate", render: (data) => {
                        if (!data) {
                            return null;
                        }
                        return moment(data, "YYYY-MM-DD HH:mm:ss").format('DD/MM/YYYY HH:mm');
                    }
                },
                {data: "approverName", name: "approverName"},
                {data: 'status', name: 'status'},
                {
                    data: 'status',
                    sortable: false,
                    searchable: false,
                    render: (data, type, row, meta) => {
                        if (row.isSelf && !row.isApprover) {
                            return "";
                        }

                        if (row.status === 'Pending') {
                            return '<button onclick="approveExpense(' + row.id + ')" data-expense-id="row.id">Approve</button><button onclick="denyExpense(' + row.id + ')">Deny</button><button onclick="deleteExpense(' + row.id + ')">Delete</button> ';
                        }
                        return "";
                    }
                }
            ],
            order: [[8, "desc"], [2, "asc"]],
            serverSide: true,
            ajax: (data, callback, settings) => {
                const test = new URL(window.location.href);
                test.searchParams.append('action', 'getExpensesData');
                fetch(test, {
                    method: 'POST',
                    body: JSON.stringify(data)
                }).then(result => result.json()).then(serverData => {
                    callback(serverData);
                    const expensesSummaryElement = document.getElementById('expensesSummary');
                    const summary = serverData.data.reduce((acc, expense) => {
                        if (expense.isSelf) {
                            if (expense.status == 'Pending') {
                                acc.pending += expense.value;
                            }
                            if (expense.status == 'Approved') {
                                acc.approved += expense.value;
                            }
                        }
                        return acc;
                    }, {approved: 0, pending: 0});
                    expensesSummaryElement.innerHTML = " Approved: &pound;" + (summary.approved.toFixed(2)) + " Pending: &pound;" + summary.pending.toFixed(2);
                });
            },
            createdRow: (row, data, index) => {
                if (data.status === 'Pending') {
                    $(row).addClass('pending');
                }
            },
            stateSave: true,
        });
        overtimeTable = $('#overtimeTable').DataTable({
            dom: 'lfrtip',
            stateSave: true,
            searchDelay: 1000,
            columns: [
                {data: "staffName", name: 'staffName'},
                {
                    data: "serviceRequestId", name: "serviceRequestId", render: (data, type, row, meta) => {
                        return '<a href="Activity.php?action=displayActivity&callActivityID=' + row.activityId + '" target="_blank">' + data + '</a>';
                    }
                },
                {
                    data: 'customerName',
                    name: 'customerName'
                },
                {
                    data: "dateSubmitted", name: "dateSubmitted", render: (data) => {
                        if (!data) {
                            return null;
                        }
                        return moment(data, "YYYY-MM-DD HH:mm:ss").format('DD/MM/YYYY');
                    }
                },
                {
                    data: "overtimeDuration", name: "overtimeDuration", sortable: false, render: (data, type, row) => {
                        if (!data) {
                            return '';
                        }
                        return data.toFixed(2);
                    }
                },
                {data: "projectDescription", name: "projectDescription"},
                {
                    data: "approvedDate", name: "approvedDate", render: (data) => {
                        if (!data) {
                            return null;
                        }
                        return moment(data, "YYYY-MM-DD HH:mm:ss").format('DD/MM/YYYY HH:mm');
                    }
                },
                {data: "approverName", name: "approverName"},
                {data: 'status', name: 'status'},
                {
                    data: 'status',
                    sortable: false,
                    searchable: false,
                    render: (data, type, row, meta) => {
                        if (row.isSelf && !row.isApprover) {
                            return "";
                        }

                        if (row.status === 'Pending') {
                            return '<button onclick="approveOvertime(' + row.activityId + ')" data-expense-id="row.id">Approve</button><button onclick="denyOvertime(' + row.activityId + ')">Deny</button>';
                        }
                        return "";
                    }
                }
            ],
            order: [[7, "desc"], [2, "asc"]],
            serverSide: true,
            ajax: (data, callback, settings) => {
                const test = new URL(window.location.href);
                test.searchParams.append('action', 'getOvertimeData');
                fetch(test, {
                    method: 'POST',
                    body: JSON.stringify(data)
                }).then(result => result.json()).then(serverData => {
                    callback(serverData);
                    const overtimeSummaryElement = document.getElementById('overtimeSummary');
                    const summary = serverData.data.reduce((acc, expense) => {
                        if (expense.isSelf) {
                            if (expense.status == 'Pending') {
                                acc.pending += expense.overtimeDuration;
                            }
                            if (expense.status == 'Approved') {
                                acc.approved += expense.overtimeDuration;
                            }
                        }
                        return acc;
                    }, {approved: 0, pending: 0});
                    overtimeSummaryElement.innerHTML = " Approved: " + (summary.approved.toFixed(2)) + " Pending: " + summary.pending.toFixed(2);
                });
            },
            processing: true,
            language: {
                'loadingRecords': '&nbsp;',
                'processing': 'Loading...'
            },
            createdRow: (row, data, index) => {
                if (data.status === 'Pending') {
                    $(row).addClass('pending');
                }
            }
        })
    })
</script>
<h1>Expenses<span id="expensesSummary"></span></h1>
<table id="expensesTable">
    <thead>
    <tr>
        <th>
            Staff Name
        </th>
        <th>
            SR Number
        </th>
        <th>
            Customer
        </th>
        <th>
            Date of expense
        </th>
        <th>
            Expense Type
        </th>
        <th>
            Expense Value
        </th>
        <th>
            Project
        </th>
        <th>
            Approved Date
        </th>
        <th>
            Approved By
        </th>
        <th>
            Approved Status
        </th>
        <th></th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>
<br>
<br>
<h1>Overtime<span id="overtimeSummary"></span></h1>
<table id="overtimeTable">
    <thead>
    <tr>
        <th>
            Staff Name
        </th>
        <th>
            SR Number
        </th>
        <th>
            Customer
        </th>
        <th>
            Date of overtime
        </th>
        <th>
            Overtime Duration
        </th>
        <th>
            Project
        </th>
        <th>
            Approved Date
        </th>
        <th>
            Approved By
        </th>
        <th>
            Approved Status
        </th>
        <th>

        </th>
    </tr>
    </thead>
    <tbody>
    </tbody>
</table>