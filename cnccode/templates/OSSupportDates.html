<style>
    .detail {
        padding-left: 10px;
    }

    .OSSupportDatesItem {
        display: flex;
        flex-direction: row;
        width: 300px;
        padding: 2px;
    }

    .OSSupportDatesItem .buttons {
        flex-basis: 100px;
    }

    .OSSupportDatesItem .email {
        flex-basis: 200px;
    }

    input {
        margin-bottom: 5px;
        margin-top: 5px;
    }

    .detail input:invalid {
        border-color: red;
    }
</style>

<script type="text/javascript"
        src=".javascript/handlebars-v4.0.11.js"
></script>
<script type="text/javascript"
        src=".javascript/mustache.min.js"
></script>
<script type="application/javascript"
        src=".javascript/mustache-wax.min.js"
></script>

<div id="dialog"
     title="Dialog Title"
>
    <form class="detail"
          onsubmit="return false;"
    >
        <input hidden
               name="id"
        >
        <div>
            <span>OS Name:</span>
            <br>
            <input type="text"
                   name="name"
                   required
            >
        </div>
        <div>
            <span>OS Version:</span>
            <br>
            <input type="number"
                   name="version"
                   required
            >
        </div>
        <div>
            <span>OS Build:</span>
            <br>
            <input type="number"
                   name="build"
                   required
            >.<input type="number"
                     name="subBuild"
        >
        </div>
        <div>
            <span>Availability Date:</span>
            <br>
            <input type="text"
                   name="availabilityDate"
                   required
                   class="jqueryCalendar"
            >
        </div>
        <div>
            <span>EOL Date:</span>
            <br>
            <input type="text"
                   name="endOfLifeDate"
                   class="jqueryCalendar"
            >
        </div>
        <div>
            <button class="addButton"
                    type="button"
                    hidden
            >Add
            </button>
            <button class="saveButton"
                    type="button"
                    hidden
            >Save
            </button>
            <button class="cancelButton"
                    type="button"
            >Cancel
            </button>
        </div>

    </form>
</div>
<script type="application/javascript">
    let customerSection = null;
    let domainInput = null;
    let saveButton = null;
    let addButton = null;
    let cancelButton = null;
    let list = null;
    let editingItem = null;

    let dataTable = null;
    let dialogElem = null;
    let form = null;

    function showEdit(data) {
        form.elements['id'].value = data.id;
        form.elements['name'].value = data.name;
        form.elements['version'].value = data.version;
        form.elements['build'].value = data.build;
        form.elements['subBuild'].value = data.subBuild;
        form.elements['availabilityDate'].value = data.availabilityDate;
        form.elements['endOfLifeDate'].value = data.endOfLifeDate;
        saveButton.show();
        addButton.hide();
        dialogElem.dialog('open');
    }

    function showNew() {
        form.elements['id'].value = null;
        form.elements['name'].value = null;
        form.elements['version'].value = null;
        form.elements['build'].value = null;
        form.elements['subBuild'].value = null;
        form.elements['availabilityDate'].value = null;
        form.elements['endOfLifeDate'].value = null;
        saveButton.hide();
        addButton.show();
        dialogElem.dialog('open');
    }

    function toggleDataTableButtons(enable) {
        dataTable.buttons(["edit:name", "delete:name"]).enable(enable);
    }

    function cancelEdit() {
        dialogElem.dialog("close");
        form.elements['id'].value = null;
        form.elements['name'].value = null;
        form.elements['version'].value = null;
        form.elements['build'].value = null;
        form.elements['subBuild'].value = null;
        form.elements['availabilityDate'].value = null;
        form.elements['endOfLifeDate'].value = null;
    }

    $(function () {
        dialogElem = $("#dialog");
        form = $('.detail')[0];
        dialogElem.dialog({autoOpen: false, position: {my: 'center', at: "top"}, modal: true});

        customerSection = $('.customerSection');
        domainInput = $('[name="domain"]');
        addButton = $('.addButton');
        saveButton = $('.saveButton');
        cancelButton = $('.cancelButton');
        list = $('.list');

        dataTable = list.DataTable({
            dom: 'Blfrtip',
            buttons: [
                {
                    extend: 'csv',
                    bom: true
                },
                {
                    text: 'Edit',
                    action: (e, dt, node, config) => {
                        const rows = dataTable.rows({selected: true}).data();
                        showEdit(rows[0]);
                    },
                    name: 'edit'

                },
                {
                    text: 'Delete',
                    action: (e, dt, node, config) => {
                        const rows = dataTable.rows({selected: true}).data();
                        if (!confirm('are you sure you want to delete this entry?')) {
                            return;
                        }


                        const urlDeleteItem = "{URLDeleteItem}&id=";
                        const url = urlDeleteItem + rows[0].id;

                        $.ajax({
                            url: url,
                            method: 'GET',
                        }).then(function (result) {
                            dataTable.ajax.reload();
                        })
                    },
                    name: 'delete'
                },
                {
                    text: 'New',
                    action: (e, dt, node, config) => {
                        showNew();
                    },
                },
            ],
            // serverSide: true,
            ajax: {
                url: "{URLGetData}",
                type: "GET"
            },
            rowId: 'id',
            select: {style: 'single'},
            columns: [
                {data: "name"},
                {data: "version"},
                {data: "build"},
                {data: "subBuild"},
                {data: "availabilityDate"},
                {data: "endOfLifeDate"}
            ],
            columnDefs: [
                {type: "date-eu", targets: [4, 5]}
            ],
            paging: false,
            order: [
                [0, 'asc'],
            ]
        });


        toggleDataTableButtons(false);
        dataTable.on('select', function (e, dt, type, indexes) {
            if (type !== 'row') {
                return;
            }
            toggleDataTableButtons(true);
        });

        dataTable.on('deselect', function (e, dt, type, indexes) {
            if (type !== 'row') {
                return;
            }
            toggleDataTableButtons(false);
        });
        // // drawList();
        // list.on('click', '.editButton', function (thing) {
        //     $elm = $(this);
        //
        //     const data = $elm.closest('.OSSupportDatesItem').data();
        //     editingItem = OSSupportDatesItems.find(e => e.id === data.id);
        //
        //     if (!editingItem) {
        //         throw Error('Failed to find element to edit');
        //     }
        //
        //     domainInput.val(editingItem.domain);
        //     const isCustomerSpecific = !!editingItem.customerID;
        //
        //     customerSection.find('[name="customerID"]').val(editingItem.customerID);
        //     customerSection.find('[name="form[customerString]"]').val(editingItem.customerString);
        //     $('[name="isCustomerSpecific"]').each(function () {
        //         const $radio = $(this);
        //         $radio.prop('checked', +$radio.val() == isCustomerSpecific);
        //     });
        //     cancelButton.show();
        //     saveButton.show();
        //     addButton.hide();
        //     detail.data('editItemID', data.id);
        // });
        //
        // list.on('click', '.deleteButton', function (thing) {
        //
        //     if (!confirm('are you sure you want to delete this entry?')) {
        //         return;
        //     }
        //
        //     $elm = $(this);
        //
        //     const data = $elm.closest('.OSSupportDatesItem').data();
        //     const foundIndex = OSSupportDatesItems.findIndex(e => e.id === data.id);
        //
        //     if (foundIndex < 0) {
        //         throw Error('Failed to find element to delete');
        //     }
        //     const urlDeleteItem = "{URLDeleteItem}&id=";
        //     const url = urlDeleteItem + data.id;
        //
        //     $.ajax({
        //         url: url,
        //         method: 'GET',
        //     }).then(function (result) {
        //         OSSupportDatesItems.splice(foundIndex, 1);
        //         drawList();
        //     })
        // });


        cancelButton.click(function () {
            cancelEdit();
        });

        saveButton.click(function () {
            debugger;
            if (!form.checkValidity()) {
                return;
            }

            const data = Array.from(form.elements).reduce((acc, element) => {
                if (element.name) acc[element.name] = element.value;
                return acc
            }, {});

            $.ajax({
                url: '{URLUpdateItem}',
                method: 'POST',
                type: 'post',
                dataType: 'json',
                data: data
            }).then(function (result) {
                cancelEdit();
                dataTable.ajax.reload();
            })

        });

        addButton.click(function () {

            if (!form.checkValidity()) {
                form.submit();
                return;
            }

            const data = Array.from(form.elements).reduce((acc, element) => {
                if (element.name) acc[element.name] = element.value;
                return acc
            }, {});

            $.ajax({
                url: '{URLAddItem}',
                method: 'POST',
                type: 'post',
                dataType: 'json',
                data: data
            }).then(function (newItem) {
                cancelEdit();
                dataTable.ajax.reload();
            })

        });

    });


    var savedCustomerString;

    function saveCustomerString() {
        savedCustomerString = document.getElementById("customerString").value
    }

</script>
<div style="display: flex">
    <table class="list">
        <thead>
        <tr>
            <th>OS Name</th>
            <th>OS Version</th>
            <th>OS Build</th>
            <th>OS SubBuild</th>
            <th>Availability Date</th>
            <th>EOL Date</th>
        </tr>
        </thead>
        <tbody>

        </tbody>
    </table>
</div>
