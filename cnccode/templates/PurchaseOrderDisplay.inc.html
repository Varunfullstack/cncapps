<!-- Template: PurchaseOrderDisplay.inc.html -->
<script language='JavaScript'
        src="CommonJS.js"
></script>
{PurchaseOrderLineEditJS}
<script language='JavaScript'>
    function checkFunctionKey(field) {
        if (event.keyCode == 120) {			// F9 - edit
            switch (field.id) {
                case "itemDescription":
                    if (document.getElementById("itemID").value != "0") {
                        window.open(
                            '{urlItemEdit}&itemID=' +
                            escape(document.getElementById("itemID").value) +
                            '&parentIDField=itemID' +
                            '&parentDescField=itemName',
                            'item',
                            'scrollbars=yes,resizable=yes,width=500,height=550,copyhistory=no, menubar=0'
                        );
                    }
                    break;
                case "supplierName":
                    if (document.getElementById("supplierID").value != "0") {
                        window.open(
                            '{urlSupplierEdit}&supplierID=' +
                            escape(document.getElementById("supplierID").value) +
                            '&parentIDField=supplierID' +
                            '&parentDescField=supplierName',
                            'supplier',
                            'scrollbars=yes,resizable=yes,height=550,width=500,copyhistory=no, menubar=0'
                        );
                    }
                    break;
                case "contactName":
                    if (document.getElementById("contactID").value != "") {
                        window.open(
                            '{urlContactEdit}' +
                            '&contactID=' + escape(document.getElementById("contactID").value) +
                            '&parentIDField=contactID' +
                            '&parentDescField=contactName',
                            'address', 'scrollbars=yes,resizable=yes,height=550,width=500,copyhistory=no, menubar=0');
                    }
                    break;
            }
        }
        return;
    }

    let purchaseOrderElement = null;

    function getPurchaseOrderId() {
        if (!purchaseOrderElement) {
            purchaseOrderElement = $('[name="porhead[1][porheadID]"]')[0];
        }
        return purchaseOrderElement.value;
    }

    const lines = {};

    function getLine(seqNo) {
        if (!lines[seqNo]) {
            const lineElm = document.querySelector('[data-seq-no="' + seqNo + '"]');
            const dateElement = lineElm.querySelector('input[type="date"]');
            const checkboxElement = lineElm.querySelector('input[type="checkbox"]');
            lines[seqNo] = {expectedDate: dateElement.value, TBC: checkboxElement.checked};
        }
        return lines[seqNo];
    }

    function expectedChanged() {
        const target = event.target;
        const seqNo = target.parentElement.dataset.seqNo;
        const line = getLine(seqNo);
        line.expectedDate = target.value;
        saveLine(line);
    }

    function tbcChanged() {
        const target = event.target;
        const seqNo = target.parentElement.dataset.seqNo;
        const line = getLine(seqNo);
        line.TBC = target.checked;
        saveLine(line);
    }

    function saveLine(line) {
        fetch('?action=saveLine', {
            method: 'POST',
            body: {purchaseOrderId: getPurchaseOrderId(), line}
        }).then(response => {
            console.log('saved correctly');
        })
    }

    function ToggleSelectedLines(checkedOn) {
        var sa = false;
        if (checkedOn)
            sa = true;
        for (var i = 0; i < document.all("orderLine").length; i++) {
            var e = document.all("orderLine", i);
            if (sa && !e.disabled)
                e.checked = true;
            else
                e.checked = false;
        }
    }
</SCRIPT>
<TABLE width="400px"
       border="0"
       cellpadding="2"
       cellspacing="1"
>
    <TR>
        <TD width="100px"
            class="navigateLink"
            valign="top"
        ><a href="{urlDeleteOrder}"
            onClick="if(!confirm('Are you sure you want to remove this order?')) return(false)"
        >{txtDeleteOrder}</a></TD>
        <TD width="100px"
            class="navigateLink"
            valign="top"
        ><a href="{urlSalesOrder}">{txtSalesOrder}</a></TD>
        <TD width="100px"
            class="navigateLink"
            valign="top"
        ><a href="{urlGeneratePDF}">{txtGeneratePDF}</a></TD>
        <TD width="100px"
            class="navigateLink"
            valign="top"
        ><a href="{urlGoodsIn}">{txtGoodsIn}</a></TD>
    </TR>
</table>
<p>{purchaseOrderHeadDisplay}</p>
<p>{purchaseOrderDisplayNewLine} <font class="formErrorMessage">{linesMessage}</font>
</p>
<table class="singleBorder"
       width="760px"
       border="0"
       cellspacing="1"
       cellpadding="1"
>
    <tr>
        <td width="260px"
            class="listHeadText"
        >Description
        </td>
        <td width="100px"
            class="listHeadText"
        >Part No
        </td>
        <td width="60px"
            class="listHeadNumber"
        >Ordered
        </td>
        <td width="60px"
            class="listHeadNumber"
        >Received
        </td>
        <td width="60px"
            class="listHeadNumber"
        >Price(&pound;)
        </td>
        <td width="60px"
            class="listHeadNumber"
        >Total(&pound;)
        </td>
        <td width="60px"
            class="listHeadText"
        >Expected
        </td>
        <td width="100px"
            class="listHeadText"
        >&nbsp;
        </td>
    </tr>
    <!-- BEGIN orderLineBlock -->
    <tr onMouseOver="this.bgColor='#FFFFCC';"
        onMouseOut="this.bgColor='';"
    >
        <td class="{orderLineClass}">{lineDescription}</td>
        <td class="{orderLineClass}">{partNo}</td>
        <td class="{orderLineClass}">
            <DIV align="right">{qtyOrdered}</DIV>
        </td>
        <td class="{orderLineClass}">
            <DIV align="right">{qtyReceived}</DIV>
        </td>
        <td class="{orderLineClass}">
            <DIV align="right">{curUnitCost}</DIV>
        </td>
        <td class="{orderLineClass}">
            <DIV align="right">{curTotalCost}</DIV>
        </td>
        <td class="{orderLineClass}">{expectedDate}</td>
        <td class="{orderLineClass}">
            <DIV align="left">{salesOrderLineIcons}</DIV>
        </td>
    </tr>
    <!-- END orderLineBlock -->
    <tr>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">
            <DIV align="right">{curGrandTotalCost}</DIV>
        </td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
    </tr>
</table>
<!-- End Template: PurchaseOrderDisplay.inc.html -->
