<!-- Template: PurchaseOrderDisplay.inc.html -->
<style>
    tr.highlightRow:hover {
        background-color: #FFFFCC;
    }

    td.failed {
        background-color: red;
    }
</style>
{PurchaseOrderLineEditJS}
<script language='JavaScript'>
    function checkFunctionKey(field) {
        if (event.keyCode == 120) {			// F9 - edit
            switch (field.id) {
                case "itemDescription":
                    if (document.getElementById("itemID").value != "0") {
                        window.open(
                            '{urlItemEdit}&itemID=' +
                            escape(document.getElementById("itemID").value) +
                            '&parentIDField=itemID' +
                            '&parentDescField=itemName',
                            'item',
                            'scrollbars=yes,resizable=yes,width=500,height=550,copyhistory=no, menubar=0'
                        );
                    }
                    break;
                case "supplierName":
                    if (document.getElementById("supplierID").value != "0") {
                        window.open(
                            '{urlSupplierEdit}&supplierID=' +
                            escape(document.getElementById("supplierID").value) +
                            '&parentIDField=supplierID' +
                            '&parentDescField=supplierName',
                            'supplier',
                            'scrollbars=yes,resizable=yes,height=550,width=500,copyhistory=no, menubar=0'
                        );
                    }
                    break;
                case "contactName":
                    if (document.getElementById("contactID").value != "") {
                        window.open(
                            '{urlContactEdit}' +
                            '&contactID=' + escape(document.getElementById("contactID").value) +
                            '&parentIDField=contactID' +
                            '&parentDescField=contactName',
                            'address', 'scrollbars=yes,resizable=yes,height=550,width=500,copyhistory=no, menubar=0');
                    }
                    break;
            }
        }
        return;
    }

    let purchaseOrderElement = null;

    function getPurchaseOrderId() {
        if (!purchaseOrderElement) {
            purchaseOrderElement = $('[name="porhead[1][porheadID]"]')[0];
        }
        return purchaseOrderElement.value;
    }

    const lines = {};

    function getLine(seqNo) {
        if (!lines[seqNo]) {
            const lineElm = document.querySelector('[data-seq-no="' + seqNo + '"]');
            const dateElement = lineElm.querySelector('input[type="date"]');
            const checkboxElement = lineElm.querySelector('input[type="checkbox"]');
            lines[seqNo] = {expectedDate: dateElement.value, TBC: checkboxElement.checked, seqNo};
        }
        return lines[seqNo];
    }

    function expectedChanged() {
        const target = event.target;
        const seqNo = target.closest('tr').dataset.seqNo;
        const line = getLine(seqNo);
        line.expectedDate = target.value;
        saveLine(line);
    }

    function tbcChanged() {
        const target = event.target;
        const seqNo = target.closest('tr').dataset.seqNo;
        const line = getLine(seqNo);
        line.TBC = target.checked;
        saveLine(line);
    }

    function saveLine(line) {
        if (!checkLineValidity(line)) {
            return;
        }

        const rowOverlay = document.createElement('div');
        const td = line.expectedDateInput.parentElement;
        const tr = td.parentElement;
        const trPosition = tr.getBoundingClientRect();
        rowOverlay.style.height = String(trPosition.height);
        rowOverlay.style.width = String(trPosition.width);
        rowOverlay.style.left = String(trPosition.left);
        rowOverlay.style.top = String(trPosition.top);
        rowOverlay.style.backgroundColor = "rgba(255, 255, 255, 0.8)";
        rowOverlay.style.position = 'absolute';
        const indicatorHolder = document.createElement('div');
        indicatorHolder.style.position = 'relative';

        const indicator = document.createElement('div');
        indicator.className = "loading";
        indicator.style.top = String(trPosition.height);
        indicatorHolder.append(indicator);
        rowOverlay.append(indicatorHolder);
        document.body.append(rowOverlay);

        fetch('?action=saveLine', {
            method: 'POST',
            body: JSON.stringify({purchaseOrderId: getPurchaseOrderId(), line})
        }).then(response => {
            rowOverlay.parentNode.removeChild(rowOverlay);
        })
    }

    let linesTable = null;

    function checkForPrint() {
        if (!checkValidity()) {
            alert("Please set an expected date or TBC (not both) for lines marked with red");
            return false;
        }
        return true;
    }

    function checkLineValidity(line) {
        let assignFailedClass = false;
        if (line.expectedDate && line.TBC || !line.expectedDate && !line.TBC) {
            // we have to put some color in the TD where the field exists
            assignFailedClass = true;
        }
        handleFailureClass(line.expectedDateInput.parentElement, assignFailedClass);
        handleFailureClass(line.TBCInput.parentElement, assignFailedClass);
        return !assignFailedClass;
    }

    function checkValidity() {
        const lines = getLines();
        let isValid = true;
        Object.keys(lines).forEach(key => {
            isValid &= checkLineValidity(lines[key]);
        })
        return isValid;
    }

    function handleFailureClass(element, assign) {
        if (assign) {
            return element.classList.add('failed');
        }
        element.classList.remove('failed');
    }

    function getLines() {
        if (!linesTable) {
            linesTable = document.getElementById('linesTable');
            for (let line of linesTable.children) {
                const data = line.dataset;
                const expectedDateInput = line.querySelector('input[type="date"]');
                if (!expectedDateInput) {
                    continue;
                }
                const TBCInput = line.querySelector('input[type="checkbox"]');
                lines[data.seqNo] = {
                    expectedDate: expectedDateInput.value,
                    TBC: TBCInput.checked,
                    seqNo: data.seqNo,
                    expectedDateInput,
                    TBCInput
                };
            }
        }

        return lines;
    }

    function ToggleSelectedLines(checkedOn) {
        var sa = false;
        if (checkedOn)
            sa = true;
        for (var i = 0; i < document.all("orderLine").length; i++) {
            var e = document.all("orderLine", i);
            if (sa && !e.disabled)
                e.checked = true;
            else
                e.checked = false;
        }
    }

    document.addEventListener("DOMContentLoaded", function () {
        checkValidity();
    });
</SCRIPT>
<TABLE width="400px"
       border="0"
       cellpadding="2"
       cellspacing="1"
>
    <TR>
        <TD width="100px"
            class="navigateLink"
            valign="top"
        ><a href="{urlDeleteOrder}"
            onClick="if(!confirm('Are you sure you want to remove this order?')) return(false)"
        >{txtDeleteOrder}</a></TD>
        <TD width="100px"
            class="navigateLink"
            valign="top"
        ><a href="{urlSalesOrder}">{txtSalesOrder}</a></TD>
        <TD width="100px"
            class="navigateLink"
            valign="top"
        ><a href="{urlGeneratePDF}"
            onclick="return checkForPrint();"
        >{txtGeneratePDF}</a></TD>
        <TD width="100px"
            class="navigateLink"
            valign="top"
        ><a href="{urlGoodsIn}">{txtGoodsIn}</a></TD>
    </TR>
</table>
<p>{purchaseOrderHeadDisplay}</p>
<p>{purchaseOrderDisplayNewLine} <font class="formErrorMessage">{linesMessage}</font>
</p>
<table class="singleBorder"
       width="760px"
       border="0"
       cellspacing="1"
       cellpadding="1"

>
    <thead>
    <tr>
        <td width="260px"
            class="listHeadText"
        >Description
        </td>
        <td width="100px"
            class="listHeadText"
        >Part No
        </td>
        <td width="60px"
            class="listHeadNumber"
        >Ordered
        </td>
        <td width="60px"
            class="listHeadNumber"
        >Received
        </td>
        <td width="60px"
            class="listHeadNumber"
        >Price(&pound;)
        </td>
        <td width="60px"
            class="listHeadNumber"
        >Total(&pound;)
        </td>
        <td width="60px"
            class="listHeadText"
        >Expected
        </td>
        <td width="60px"
            class="listHeadText"
        >TBC
        </td>
        <td width="100px"
            class="listHeadText"
        >&nbsp;
        </td>
    </tr>
    </thead>
    <tbody id="linesTable">
    <!-- BEGIN orderLineBlock -->
    <tr class="highlightRow"
        data-seq-no='{seqNo}'
        data-item-id="{itemID}"
    >
        <td class="{orderLineClass}">{lineDescription}</td>
        <td class="{orderLineClass}">{partNo}</td>
        <td class="{orderLineClass}">
            <DIV align="right">{qtyOrdered}</DIV>
        </td>
        <td class="{orderLineClass}">
            <DIV align="right">{qtyReceived}</DIV>
        </td>
        <td class="{orderLineClass}">
            <DIV align="right">{curUnitCost}</DIV>
        </td>
        <td class="{orderLineClass}">
            <DIV align="right">{curTotalCost}</DIV>
        </td>
        <td class="{orderLineClass}">{expectedDate}</td>
        <td class="{orderLineClass}">{TBCInput}</td>
        <td class="{orderLineClass}">
            <DIV align="left">{salesOrderLineIcons}</DIV>
        </td>
    </tr>
    <!-- END orderLineBlock -->
    </tbody>
    <tfoot>
    <tr>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">
            <DIV align="right">{curGrandTotalCost}</DIV>
        </td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
        <td class="orderTotalItem">&nbsp;</td>
    </tr>
    </tfoot>
</table>
<!-- End Template: PurchaseOrderDisplay.inc.html -->
