<style>
    .list {
        float: left;
        border-right: solid 2px blue;
        padding-right: 5px;
    }

    .detail {
        float: left;
        padding-left: 5px;
    }

    .emailItem {
        display: flex;
        flex-direction: row;
        width: 300px;
        padding: 2px;
    }

    .emailItem .buttons {
        flex-basis: 100px;
    }

    .emailItem .email {
        flex-basis: 200px;
    }

</style>

<script type="text/javascript"
        src=".javascript/handlebars-v4.0.11.js"
></script>
<script type="text/javascript"
        src=".javascript/mustache.min.js"
></script>
<script type="application/javascript"
        src=".javascript/mustache-wax.min.js"
></script>

<script id="email-items-template"
        type="text/template"
>
    {% #emailItems %}
    <div class="emailItem"
         data-id="{% id %}"
    >
        <div class="email">
            <span>{% firstPart %}@{% lastPart %}</span>
        </div>
        <div class="buttons">
            <button class="editButton">Edit</button>
            <button class="deleteButton">Delete</button>
        </div>
    </div>
    {% /emailItems %}
    {% ^emailItems %}
    There are no emails yet
    {% /emailItems %}
</script>
<script type="application/javascript">
    let lastPartInput = null;
    let firstPartInput = null;
    let saveButton = null;
    let addButton = null;
    let cancelButton = null;
    let list = null;

    let emailItems = [];

    function changeWildCard(value) {
        if (value) {
            lastPartInput.prop('disabled', true);
            lastPartInput.val('*');
        } else {
            lastPartInput.prop('disabled', false);
            lastPartInput.val('');
        }
    }

    $.ajax({
        url: '{URLGetData}',
        method: 'GET',
        dataType: 'JSON'
    }).then(function (result) {
        emailItems = result;
        drawList();
    })

    Mustache.tags = ['{%', '%}'];

    Mustache.Formatters = {
        decimal: function (number) {
            if (typeof number !== 'number') {
                return number;
            }

            return number.toFixed(2);
        },
        lightGrayClass: function (number) {

            if (isNaN(parseFloat(number)) || !isFinite(number)) {
                debugger;
                return null;
            }

            if (number != 0) {
                return null;
            }

            return "grey"
        }

    };
    let editingItem = null;

    function drawList() {
        const source = document.getElementById("email-items-template").innerHTML;
        const context = {emailItems: emailItems};
        const html = Mustache.to_html(source, context);
        list.html(html);
    }

    $(function () {
        lastPartInput = $('[name="lastPart"]');
        firstPartInput = $('[name="firstPart"]');
        addButton = $('.addButton');
        saveButton = $('.saveButton');
        cancelButton = $('.cancelButton');
        detail = $('.detail');
        list = $('.list');
        drawList();
        list.on('click', '.editButton', function (thing) {
            $elm = $(this);

            const data = $elm.closest('.emailItem').data();
            editingItem = emailItems.find(e => e.id === data.id);

            if (!editingItem) {
                throw Error('Failed to find element to edit');
            }

            firstPartInput.val(editingItem.firstPart);
            const isWildCard = editingItem.lastPart === '*';
            changeWildCard(isWildCard);
            lastPartInput.val(editingItem.lastPart);
            $('[name="isWildCard"]').each(function () {
                const $radio = $(this);
                $radio.prop('checked', +$radio.val() == isWildCard);
            });
            cancelButton.show();
            saveButton.show();
            addButton.hide();
            detail.data('editItemID', data.id);
        });

        list.on('click', '.deleteButton', function (thing) {

            if (!confirm('are you sure you want to delete this entry?')) {
                return;
            }

            $elm = $(this);

            const data = $elm.closest('.emailItem').data();
            const foundIndex = emailItems.findIndex(e => e.id === data.id);

            if (foundIndex < 0) {
                throw Error('Failed to find element to delete');
            }
            const urlDeleteItem = "{URLDeleteItem}&id=";
            const url = urlDeleteItem + data.id;

            $.ajax({
                url: url,
                method: 'GET',
            }).then(function (result) {
                emailItems.splice(foundIndex, 1);
                drawList();
            })
        });


        cancelButton.click(function () {
            cancelEdit();
        });

        saveButton.click(function () {
            console.log('save button');
            if (!detail[0].checkValidity()) {
                detail.submit();
                return;
            }

            const data = {
                firstPart: firstPartInput.val(),
                lastPart: lastPartInput.val(),
                id: editingItem.id
            };

            $.ajax({
                url: '{URLUpdateItem}',
                method: 'POST',
                type: 'post',
                dataType: 'json',
                data: data
            }).then(function (result) {
                editingItem.firstPart = data.firstPart;
                editingItem.lastPart = data.lastPart;

                drawList();
                cancelEdit();
            })

        });

        addButton.click(function () {
            if (!detail[0].checkValidity()) {
                detail.submit();
                return;
            }

            const data = {
                firstPart: firstPartInput.val(),
                lastPart: lastPartInput.val(),
            };

            if (isDuplicate(data)) {
                alert('This utility email exists already');
                return;
            }

            $.ajax({
                url: '{URLAddItem}',
                method: 'POST',
                type: 'post',
                dataType: 'json',
                data: data
            }).then(function (newItem) {
                emailItems.push(newItem);
                drawList();
                cancelEdit();
            })

        })


    });

    function isDuplicate(utilityEmailToCheck) {
        return emailItems.some(e => e.firstPart == utilityEmailToCheck.firstPart && e.lastPart == utilityEmailToCheck.lastPart && e.id != utilityEmailToCheck.id);
    }

    function cancelEdit() {
        changeWildCard(true);
        $('[name="isWildCard"]').each(function () {
            const $radio = $(this);
            $radio.prop('checked', +$radio.val());
        });
        cancelButton.hide();
        saveButton.hide();
        addButton.show();
        editingItem = null;
        firstPartInput.val('');
    }


</script>
<div class="list">
</div>
<form class="detail"
      onsubmit="return false;"
>
    <div>
        <label>
            <input type="radio"
                   name="isWildCard"
                   value="1"
                   onchange="changeWildCard(1)"
                   checked
            > Wildcard
        </label>
        <label>
            <input type="radio"
                   name="isWildCard"
                   value="0"
                   onchange="changeWildCard(0)"

            > Specific
        </label>
    </div>
    <div>
        email:
        <input type="text"
               name="firstPart"
               required
        >
        @
        <input type="text"
               name="lastPart"
               value="*"
               disabled
               required
        >
    </div>
    <div>
        <button class="addButton"
                type="button"
        >Add
        </button>
        <button class="saveButton"
                type="button"
                hidden
        >Save
        </button>
        <button class="cancelButton"
                hidden
                type="button"
        >Cancel
        </button>
    </div>

</form>