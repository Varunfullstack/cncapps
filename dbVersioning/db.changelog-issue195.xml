<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:ext="http://www.liquibase.org/xml/ns/dbchangelog-ext"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog-ext http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-ext.xsd http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet author="pavwebdev" id="issue195-1524127856-0">
        <tagDatabase tag="issue195"/>
    </changeSet>
    <changeSet id="issue195-1524127856-1" author="pavwebdev">
        <createProcedure >
            DELIMITER $$
            DROP FUNCTION IF EXISTS `getToLogHours`$$

            CREATE DEFINER=`root`@`localhost` FUNCTION `getToLogHours`(userID INTEGER, givenDate DATE, days INTEGER) RETURNS FLOAT
            BEGIN

            DECLARE result FLOAT;

            SELECT
            SUM(u.`dayHours`) INTO result
            FROM
            (SELECT
            *
            FROM
            user_time_log a
            WHERE a.userID = userID
            AND a.loggedDate <= givenDate
            ORDER BY a.loggedDate DESC
            LIMIT days) u;

            RETURN result;

            END$$

            DELIMITER ;
        </createProcedure>
    </changeSet>
</databaseChangeLog>
