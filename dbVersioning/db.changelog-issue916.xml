<?xml version="1.1" encoding="UTF-8" standalone="no"?>
<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.5.xsd">
    <changeSet author="pavwebdev" id="issue916-0">
        <tagDatabase tag="issue916"/>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-1">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contact" columnName="workStartedEmailFlag"/>
        </preConditions>
        <dropColumn tableName="contact" columnName="workStartedEmailFlag"/>
        <rollback>
            <addColumn tableName="contact">
                <column name="workStartedEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-2">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contact" columnName="workUpdatesEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contact" columnName="workUpdatesEmailFlag"/>
        <rollback>
            <addColumn tableName="contact">
                <column name="workUpdatesEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-3">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contact" columnName="pendingClosureEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contact" columnName="pendingClosureEmailFlag"/>
        <rollback>
            <addColumn tableName="contact">
                <column name="pendingClosureEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-4">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contact" columnName="closureEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contact" columnName="closureEmailFlag"/>
        <rollback>
            <addColumn tableName="contact">
                <column name="closureEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-5">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contact" columnName="othersWorkStartedEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contact" columnName="othersWorkStartedEmailFlag"/>
        <rollback>
            <addColumn tableName="contact">
                <column name="othersWorkStartedEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-6">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contact" columnName="othersPendingClosureEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contact" columnName="othersPendingClosureEmailFlag"/>
        <rollback>
            <addColumn tableName="contact">
                <column name="othersPendingClosureEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-7">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contact" columnName="othersClosureEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contact" columnName="othersClosureEmailFlag"/>
        <rollback>
            <addColumn tableName="contact">
                <column name="othersClosureEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-8">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contactAuditLog" columnName="workStartedEmailFlag"/>
        </preConditions>
        <dropColumn tableName="contactAuditLog" columnName="workStartedEmailFlag"/>
        <rollback>
            <addColumn tableName="contactAuditLog">
                <column name="workStartedEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-9">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contactAuditLog" columnName="workUpdatesEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contactAuditLog" columnName="workUpdatesEmailFlag"/>
        <rollback>
            <addColumn tableName="contactAuditLog">
                <column name="workUpdatesEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-10">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contactAuditLog" columnName="pendingClosureEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contactAuditLog" columnName="pendingClosureEmailFlag"/>
        <rollback>
            <addColumn tableName="contactAuditLog">
                <column name="pendingClosureEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-11">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contactAuditLog" columnName="closureEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contactAuditLog" columnName="closureEmailFlag"/>
        <rollback>
            <addColumn tableName="contactAuditLog">
                <column name="closureEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-12">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contactAuditLog" columnName="othersWorkStartedEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contactAuditLog" columnName="othersWorkStartedEmailFlag"/>
        <rollback>
            <addColumn tableName="contactAuditLog">
                <column name="othersWorkStartedEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-13">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contactAuditLog" columnName="othersPendingClosureEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contactAuditLog" columnName="othersPendingClosureEmailFlag"/>
        <rollback>
            <addColumn tableName="contactAuditLog">
                <column name="othersPendingClosureEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>

        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-14">
        <preConditions onFail="MARK_RAN">
            <columnExists tableName="contactAuditLog" columnName="othersClosureEmailFlag"/>
        </preConditions>

        <dropColumn tableName="contactAuditLog" columnName="othersClosureEmailFlag"/>
        <rollback>
            <addColumn tableName="contactAuditLog">
                <column name="othersClosureEmailFlag" type="char(1)" defaultValue="Y"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-15">
        <comment>
            This assigns at least one STM contact for each customer
        </comment>
        <sql>
           <![CDATA[
            UPDATE
                contact
                    JOIN
                    (SELECT c.`con_contno`
                     FROM (SELECT *
                           FROM contact) c
                              LEFT JOIN
                          (SELECT COUNT(*) AS totalStatementContacts,
                                  con_custno
                           FROM contact b
                           WHERE b.con_mailflag4 = 'Y'
                           GROUP BY b.con_custno) a
                          ON c.con_custno = a.con_custno
                     WHERE con_suppno = 0
                       AND (
                             a.totalStatementContacts < 1
                             OR a.totalStatementContacts IS NULL
                         )
                     GROUP BY c.con_custno) d
                    ON contact.`con_contno` = d.con_contno
            SET con_mailflag4 = 'Y';
            ]]>
        </sql>
        <rollback/>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-16">
        <comment>
            This makes sure that each customer has AT MOST one STM contact
        </comment>
        <sql>
           <![CDATA[
            UPDATE
                contact
                    JOIN
                    (SELECT c.`con_contno`
                     FROM (SELECT *
                           FROM contact) c
                              LEFT JOIN
                          (SELECT COUNT(*) AS totalStatementContacts,
                                  con_custno
                           FROM contact b
                           WHERE b.con_mailflag4 = 'Y'
                           GROUP BY b.con_custno) a
                          ON c.con_custno = a.con_custno
                     WHERE con_suppno = 0
                       AND (
                             a.totalStatementContacts < 1
                             OR a.totalStatementContacts IS NULL
                         )
                     GROUP BY c.con_custno) d
                    ON contact.`con_contno` = d.con_contno
            SET con_mailflag4 = 'Y';
            ]]>
        </sql>
        <rollback/>
    </changeSet>

    <changeSet author="pavwebdev" id="issue916-17">
        <preConditions onFail="MARK_RAN">
            <not>
                <columnExists tableName="customer" columnName="statementContactId"/>
            </not>
        </preConditions>
        <addColumn tableName="customer">
            <column name="statementContactId" type="tinyint(1)" defaultValue="0">
                <constraints nullable="false"/>
            </column>
        </addColumn>

        <sql>
            update customer
            set statementContactId = (select con_contno
                                      from contact
                                      where con_custno = customer.cus_custno
                                        and con_mailflag4 = 'Y'
                                      limit 1)
        </sql>
        <rollback/>
    </changeSet>

    <changeSet author="pavwebdev" id="issue916-18">
        <dropColumn tableName="contact" columnName="con_mailflag4"/>
        <rollback>
            <addColumn tableName="contact">
                <column name="con_mailflag4" remarks="Refer to header table for meaning" type="CHAR(1)"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-19">
        <dropColumn tableName="contactAuditLog" columnName="con_mailflag4"/>
        <rollback>
            <addColumn tableName="contactAuditLog">
                <column name="con_mailflag4" remarks="Refer to header table for meaning" type="CHAR(1)"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-20">
        <dropColumn tableName="headert" columnName="hed_mailflg4_def"/>
        <rollback>
            <addColumn tableName="headert">
                <column name="hed_mailflg4_def" remarks="Contact Flag Default Value" type="CHAR(1)" defaultValue="N"/>
            </addColumn>
        </rollback>
    </changeSet>
    <changeSet author="pavwebdev" id="issue916-21">
        <dropColumn tableName="headert" columnName="hed_mailflg4_desc"/>
        <rollback>
            <addColumn tableName="headert">
                <column name="hed_mailflg4_desc" remarks="Contact Flag Description" type="CHAR(30)" defaultValue="Stm"/>
            </addColumn>
        </rollback>
    </changeSet>


</databaseChangeLog>